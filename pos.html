<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma ‚Äî POS</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-strong:#1d4ed8;
      --accent-soft:#dbeafe;
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:var(--panel);border:1px solid var(--border);border-radius:20px;
      padding:12px 12px;box-shadow:var(--shadow)
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:240px
    }
    .logo{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(135deg,var(--accent-soft),#fff);
      display:grid;place-items:center;font-weight:900;color:var(--accent)
    }
    .brand h1{font-size:16px;margin:0}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid var(--border);background:var(--panel-soft);color:var(--ink);
      padding:10px 12px;border-radius:14px;font-weight:800;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.danger{background:#fff;border-color:#fecaca;color:#b91c1c}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .pill{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--border);background:var(--panel-soft);
      padding:8px 10px;border-radius:999px;font-weight:800;font-size:12px;color:var(--muted)
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .grid{
      display:grid;grid-template-columns:1.3fr .9fr;gap:14px;margin-top:14px
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:20px;
      box-shadow:var(--shadow);overflow:hidden
    }
    .card-h{padding:14px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .card-h h2{margin:0;font-size:14px}
    .mini{color:var(--muted);font-size:12px;margin-top:4px}
    .card-b{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:180px}
    label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin:0 0 6px}
    .input, textarea, select{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--panel-soft);font-weight:700;font-family:inherit;outline:none
    }
    textarea{min-height:80px;resize:vertical}
    .products{
      display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px
    }
    @media (max-width: 980px){ .products{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .products{grid-template-columns:1fr} }
    .p{
      border:1px solid var(--border);background:var(--panel-soft);border-radius:16px;
      padding:10px;cursor:pointer;display:flex;gap:10px;align-items:center
    }
    .p:hover{border-color:#d1d5db}
    .pimg{width:46px;height:46px;border-radius:14px;border:1px solid var(--border);background:#fff;overflow:hidden;display:grid;place-items:center}
    .pimg img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:13px}
    .pcat{font-size:11px;color:var(--muted);margin-top:2px}
    .pprice{font-weight:900;font-size:12px;color:var(--accent);margin-top:6px}
    .line{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      border:1px solid var(--border);background:var(--panel-soft);border-radius:16px;padding:10px;margin-top:10px
    }
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{
      width:34px;height:34px;border-radius:12px;border:1px solid var(--border);
      background:#fff;font-weight:900;cursor:pointer
    }
    .qty .n{min-width:26px;text-align:center;font-weight:900}
    .muted{color:var(--muted);font-size:12px}
    .totals{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .totrow{display:flex;justify-content:space-between;gap:10px;margin-top:8px;font-weight:800}
    .drawer{
      position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:center;padding:14px;z-index:50
    }
    .sheet{
      width:min(920px, 100%);
      max-height:86vh;overflow:auto;background:var(--panel);border-radius:22px;border:1px solid var(--border);
      box-shadow:var(--shadow)
    }
    .sh{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .sh h3{margin:0;font-size:14px}
    .sb{padding:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel-soft);
      font-weight:900;font-size:12px;cursor:pointer
    }
    .chip.active{background:var(--accent-soft);border-color:#bfdbfe}
    .pm{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:var(--panel-soft);font-weight:900;cursor:pointer}
    .pm.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .paymethods{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none!important}
    .toast{position:fixed;right:14px;bottom:14px;z-index:60;display:none}
    .tcard{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:12px 14px;min-width:260px}
    .tcard b{display:block}
    footer{margin:16px 0 10px;text-align:center;color:var(--muted);font-weight:800;font-size:12px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="brandLogoBox">L</div>
        <div>
          <h1 id="brandTitle">POS</h1>
          <div class="sub" id="brandSub">Not signed in</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill"><span class="dot warn" id="pillDot"></span><span id="pillText">Not signed in</span></div>
        <button class="btn" id="btnOpenAuth">Login</button>
        <button class="btn" id="btnOpenSettings" disabled>Settings</button>
        <button class="btn" id="btnOpenProducts" disabled>Products</button>
        <button class="btn" id="btnOpenOrders" disabled>Orders</button>
        <button class="btn danger" id="btnSignOut" disabled>Sign out</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <div>
            <h2>Menu</h2>
            <div class="mini">Search & tap a product to add. Categories auto-detected.</div>
          </div>
          <div style="min-width:260px">
            <label>Search</label>
            <input class="input" id="q" placeholder="e.g. burger, fries‚Ä¶" />
          </div>
        </div>
        <div class="card-b">
          <div class="row">
            <div class="field" style="min-width:220px;flex:1.2">
              <label>Category</label>
              <select id="cat" class="input"><option value="">All</option></select>
            </div>
            <div class="field" style="min-width:220px">
              <label>Charges (from settings)</label>
              <div class="pill" style="height:44px">
                <span class="dot ok"></span>
                <span><b>Tax</b>: <span id="taxRateLabel">0%</span> ‚Ä¢ <b>Service</b>: <span id="serviceRateLabel">0%</span></span>
              </div>
            </div>
            <div class="field" style="min-width:180px">
              <label>Discount (%)</label>
              <input class="input" id="discount" placeholder="0" inputmode="decimal"/>
            </div>
          </div>
          <div class="products" id="productsGrid"></div>
          <div class="mini" id="productsHint" style="margin-top:10px">Sign in to load products.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <div>
            <h2>Cart</h2>
            <div class="mini" id="cartMeta">0 items</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn" id="btnClear" disabled>Clear</button>
          </div>
        </div>
        <div class="card-b">
          <div id="cartLines"></div>
          <div class="muted" id="cartEmpty" style="margin-top:6px">Cart is empty.</div>

          <div class="totals">
            <div class="totrow"><span>Subtotal</span><strong id="tSubtotal">0.00</strong></div>
            <div class="totrow"><span>Discount</span><strong id="tDiscount">0.00</strong></div>
            <div class="totrow"><span>Service</span><strong id="tService">0.00</strong></div>
            <div class="totrow"><span>Tax</span><strong id="tTax">0.00</strong></div>
            <div class="totrow" style="font-size:16px"><span>Total</span><strong id="tTotal">0.00</strong></div>
          </div>

          <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
            <button class="btn primary" id="btnPay" disabled>Checkout</button>
          </div>

          <div class="mini" id="afterPayHint" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <footer>Powered by Luma</footer>
  </div>

  <!-- AUTH MODAL -->
  <div class="drawer" id="authDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Login</h3>
        <button class="btn" id="btnCloseAuth">Close</button>
      </div>
      <div class="sb">
        <div class="row">
          <div class="field" style="min-width:260px;flex:1.2">
            <label>Brand ID</label>
            <input class="input" id="brandId" placeholder="e.g. oudies" autocomplete="off"/>
            <div class="mini">Saved locally (no URL params).</div>
          </div>
        </div>

        <div class="chips" id="authTabs" style="margin-top:10px">
          <div class="chip active" data-tab="owner">Owner</div>
          <div class="chip" data-tab="staff">Staff</div>
        </div>

        <div id="tabOwner" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><div><h2>Owner login</h2><div class="mini">Firebase Auth (email + password)</div></div></div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>Email</label>
                  <input class="input" id="email" placeholder="you@company.com" autocomplete="email"/>
                </div>
                <div class="field">
                  <label>Password</label>
                  <input class="input" id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
                </div>
              </div>
              <div class="row" style="margin-top:10px;justify-content:flex-end;gap:10px">
                <button class="btn" id="btnRegister">Register</button>
                <button class="btn primary" id="btnLogin">Sign in</button>
              </div>
              <div class="mini" id="authMsg" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <div id="tabStaff" class="hidden" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><div><h2>Staff login</h2><div class="mini">Username + PIN (from Vendor Dashboard ‚Üí Staff)</div></div></div>
            <div class="card-b">
              <div class="row">
                <div class="field">
                  <label>Username</label>
                  <input class="input" id="staffUser" placeholder="e.g. cashier1" autocomplete="off"/>
                </div>
                <div class="field">
                  <label>PIN</label>
                  <input class="input" id="staffPin" placeholder="4-6 digits" inputmode="numeric" autocomplete="off"/>
                </div>
              </div>
              <div class="row" style="margin-top:10px;justify-content:flex-end">
                <button class="btn primary" id="btnStaffLogin">Enter POS</button>
              </div>
              <div class="mini" id="staffMsg" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <div class="mini" style="margin-top:12px">Data paths: <code>brands/{brandId}/products</code>, <code>brands/{brandId}/orders</code></div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div class="drawer" id="checkoutDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Checkout</h3>
        <button class="btn" id="btnCloseCheckout">Close</button>
      </div>
      <div class="sb">
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Order summary</h2>
              <div class="mini" id="coMeta">‚Äî</div>
            </div>
          </div>
          <div class="card-b">
            <div id="coLines"></div>

            <div class="totals" style="margin-top:12px">
              <div class="totrow"><span>Subtotal</span><strong id="coSubtotal">0.00</strong></div>
              <div class="totrow"><span>Discount</span><strong id="coDiscount">0.00</strong></div>
              <div class="totrow"><span>Service</span><strong id="coService">0.00</strong></div>
              <div class="totrow"><span>Tax</span><strong id="coTax">0.00</strong></div>
              <div class="totrow" style="font-size:16px"><span>Total</span><strong id="coTotal">0.00</strong></div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="field">
                <label>Payment method</label>
                <div class="paymethods" id="coPayMethods">
                  <div class="pm active" data-m="cash">Cash</div>
                  <div class="pm" data-m="card">Card</div>
                  <div class="pm" data-m="wallet">Wallet</div>
                </div>
              </div>
              <div class="field">
                <label>Customer name (optional)</label>
                <input class="input" id="coCustomer" placeholder="Walk-in"/>
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>Kitchen note (order-level)</label>
              <textarea id="coOrderNote" placeholder="e.g. extra napkins, no ice‚Ä¶"></textarea>
            </div>

            <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
              <button class="btn" id="btnEditCart">Back</button>
              <button class="btn primary" id="btnConfirmPay">Confirm payment</button>
            </div>
            <div class="mini" id="coHint" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCTS MANAGER MODAL -->
  <div class="drawer" id="productsDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Products</h3>
        <button class="btn" id="btnCloseProducts">Close</button>
      </div>
      <div class="sb">
        <div class="card">
          <div class="card-h"><div><h2>Add product</h2><div class="mini">Upload image to Storage and save URL.</div></div></div>
          <div class="card-b">
            <div class="row">
              <div class="field"><label>Name</label><input class="input" id="pName" placeholder="e.g. Cheeseburger"/></div>
              <div class="field"><label>Category</label><input class="input" id="pCat" placeholder="e.g. Burgers"/></div>
            </div>
            <div class="row" style="margin-top:10px">
              <div class="field"><label>Price (EGP)</label><input class="input" id="pPrice" placeholder="0" inputmode="decimal"/></div>
              <div class="field"><label>Image (optional)</label><input class="input" id="pImg" type="file" accept="image/*"/></div>
            </div>
            <div class="field" style="margin-top:10px">
              <label>Description (optional)</label>
              <textarea id="pDesc" placeholder="Short description‚Ä¶"></textarea>
            </div>
            <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
              <button class="btn" id="btnResetProduct">Reset</button>
              <button class="btn primary" id="btnAddProduct">Add product</button>
            </div>
            <div class="mini" id="prodMsg" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><div><h2>Existing products</h2><div class="mini">Tap a product to quick-add to cart (POS uses the live menu too).</div></div></div>
          <div class="card-b">
            <div id="prodListMini"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="drawer" id="settingsDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>POS Settings</h3>
        <button class="btn" id="btnCloseSettings">Close</button>
      </div>
      <div class="sb">
        <div class="card">
          <div class="card-h"><div><h2>Taxes & service</h2><div class="mini">Saved at <code>brands/{brandId}/settings/pos</code></div></div></div>
          <div class="card-b">
            <div class="row">
              <div class="field"><label>Tax rate (%)</label><input class="input" id="setTaxRate" placeholder="e.g. 14" inputmode="decimal"/></div>
              <div class="field"><label>Service rate (%)</label><input class="input" id="setServiceRate" placeholder="e.g. 12" inputmode="decimal"/></div>
            </div>
            <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
              <button class="btn" id="btnResetSettings">Reset</button>
              <button class="btn primary" id="btnSaveSettings">Save</button>
            </div>
            <div class="mini" id="settingsMsg" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ORDERS MODAL -->
  <div class="drawer" id="ordersDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Orders</h3>
        <button class="btn" id="btnCloseOrders">Close</button>
      </div>
      <div class="sb">
        <div class="row">
          <div class="field" style="min-width:220px">
            <label>Status filter</label>
            <select id="ordStatus" class="input">
              <option value="">All</option>
              <option value="preparing">Preparing</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        <div id="ordersList" style="margin-top:10px"></div>
        <div class="mini" id="ordersMsg" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- REFUND MODAL -->
  <div class="drawer" id="refundDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Refund</h3>
        <button class="btn" id="btnCloseRefund">Close</button>
      </div>
      <div class="sb">
        <div class="mini" id="rfMeta">‚Äî</div>

        <div class="chips" style="margin-top:10px">
          <div class="chip active" id="rfModeFull">Full order</div>
          <div class="chip" id="rfModeItems">By items</div>
        </div>

        <div id="rfItemsWrap" class="hidden" style="margin-top:12px"></div>

        <div class="row" style="margin-top:14px;justify-content:flex-end;gap:10px">
          <button class="btn" id="btnCancelRefund">Cancel</button>
          <button class="btn primary" id="btnConfirmRefund">Confirm refund</button>
        </div>

        <div class="mini" id="rfHint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="tcard">
      <b id="tTitle">Title</b>
      <div class="muted" id="tBody">Body</div>
    </div>
  </div>

  <script type="module">
    // ================== 1) Firebase config (PASTE YOUR CREDENTIALS HERE) ==================
    const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  
    };
    // ======================================================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, doc, collection, addDoc, setDoc, getDoc, getDocs, updateDoc,
  onSnapshot, serverTimestamp, query, where, orderBy, limit, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const $ = (id)=> document.getElementById(id);

    // -------- UI helpers --------
    function openDrawer(id, yes){ $(id).style.display = yes ? "flex" : "none"; }
    ["authDrawer","checkoutDrawer","productsDrawer","settingsDrawer","ordersDrawer","refundDrawer"].forEach(id=>{
      $(id).addEventListener("click", (e)=>{ if(e.target === $(id)) openDrawer(id,false); });
    });

    function toast(title, body=""){
      $("tTitle").textContent = title;
      $("tBody").textContent = body;
      $("toast").style.display = "block";
      clearTimeout(window.__tto);
      window.__tto = setTimeout(()=> $("toast").style.display="none", 2600);
    }
    function money(n){ return (Number(n||0)).toFixed(2); }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // -------- State --------
    let BRAND_ID = "";
    let BRAND = null;
    let ROLE = "guest";
    let STAFF = null;

    let PRODUCTS = [];
    let CART = [];
    let PAY_METHOD = "cash";
    let POS_SETTINGS = { taxRate: 0, serviceRate: 0 };

    let unsubProducts = null;
    let unsubOrders = null;

    function basePaths(brandId){
      return {
        brandDoc: doc(db, `brands/${brandId}`),
        productsCol: collection(db, `brands/${brandId}/products`),
        ordersCol: collection(db, `brands/${brandId}/orders`),
        staffCol: collection(db, `brands/${brandId}/staff`),
        settingsPosDoc: doc(db, `brands/${brandId}/settings/pos`),
        countersDoc: doc(db, `brands/${brandId}/counters/orders`),
        runtimeCustomerDoc: doc(db, `brands/${brandId}/runtime/customerDisplay`)
      };
    }

    function setPill(kind, text){
      $("pillText").textContent = text;
      $("brandSub").textContent = text;
      $("pillDot").className = "dot " + (kind==="ok" ? "ok" : "warn");
    }

    // -------- Ensure structure --------
    async function ensureBrandShell(brandId){
      const { brandDoc, settingsPosDoc, countersDoc, runtimeCustomerDoc } = basePaths(brandId);

      const b = await getDoc(brandDoc);
      if(!b.exists()){
        await setDoc(brandDoc, {
          name: brandId,
          status: "active",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
      }else{
        await updateDoc(brandDoc, { updatedAt: serverTimestamp() }).catch(()=>{});
      }

      const s = await getDoc(settingsPosDoc);
      if(!s.exists()){
        await setDoc(settingsPosDoc, { taxRate: 0, serviceRate: 0, updatedAt: serverTimestamp() }, { merge:true });
      }

      const c = await getDoc(countersDoc);
      if(!c.exists()){
        await setDoc(countersDoc, { nextOrderNo: 1000, updatedAt: serverTimestamp() }, { merge:true });
      }

      const r = await getDoc(runtimeCustomerDoc);
      if(!r.exists()){
        await setDoc(runtimeCustomerDoc, { lastPaidOrderId: null, lastPaidAt: null, updatedAt: serverTimestamp() }, { merge:true });
      }
    }

    async function loadBrand(brandId){
      const { brandDoc } = basePaths(brandId);
      const snap = await getDoc(brandDoc);
      BRAND = snap.exists() ? snap.data() : { name: brandId };
      $("brandTitle").textContent = BRAND?.name || brandId;
      const lb = $("brandLogoBox");
      if(BRAND?.logoUrl){
        lb.innerHTML = `<img alt="logo" src="${escapeHtml(BRAND.logoUrl)}" style="width:100%;height:100%;object-fit:cover;border-radius:14px"/>`;
      }else{
        lb.textContent = (BRAND?.name || "L").slice(0,1).toUpperCase();
      }
    }

    async function loadPosSettings(){
      const { settingsPosDoc } = basePaths(BRAND_ID);
      const snap = await getDoc(settingsPosDoc);
      const data = snap.exists() ? (snap.data()||{}) : {};
      POS_SETTINGS = {
        taxRate: Number(data.taxRate||0),
        serviceRate: Number(data.serviceRate||0)
      };
      $("taxRateLabel").textContent = `${POS_SETTINGS.taxRate||0}%`;
      $("serviceRateLabel").textContent = `${POS_SETTINGS.serviceRate||0}%`;

      $("setTaxRate").value = String(POS_SETTINGS.taxRate||0);
      $("setServiceRate").value = String(POS_SETTINGS.serviceRate||0);

      recalc();
    }

    // -------- Products realtime --------
    function watchProducts(){
      if(unsubProducts) unsubProducts();
      const { productsCol } = basePaths(BRAND_ID);
      unsubProducts = onSnapshot(productsCol, (qs)=>{
        PRODUCTS = [];
        qs.forEach(d=> PRODUCTS.push({ id:d.id, ...d.data() }));
        renderProducts();
        renderProductsMini();
      });
    }

    function renderProducts(){
      const qtxt = ($("q").value||"").trim().toLowerCase();
      const cat = $("cat").value || "";
      const list = PRODUCTS
        .filter(p=> !cat || (p.category||"")===cat )
        .filter(p=> !qtxt || String(p.name||"").toLowerCase().includes(qtxt) || String(p.category||"").toLowerCase().includes(qtxt));

      const cats = Array.from(new Set(PRODUCTS.map(p=>p.category||"Uncategorized"))).sort((a,b)=>a.localeCompare(b));
      const prev = $("cat").value;
      $("cat").innerHTML = `<option value="">All</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      $("cat").value = prev;

      const grid = $("productsGrid");
      grid.innerHTML = "";
      for(const p of list){
        const el = document.createElement("div");
        el.className = "p";
        const img = p.imageUrl ? `<img src="${escapeHtml(p.imageUrl)}" alt="">` : `<div style="font-weight:900;color:var(--muted)">üçî</div>`;
        el.innerHTML = `
          <div class="pimg">${img}</div>
          <div style="flex:1">
            <div class="pname">${escapeHtml(p.name||"Unnamed")}</div>
            <div class="pcat">${escapeHtml(p.category||"Uncategorized")}</div>
            <div class="pprice">${money(p.price)} EGP</div>
          </div>
        `;
        el.onclick = ()=> addToCart(p);
        grid.appendChild(el);
      }
      $("productsHint").textContent = list.length ? `${list.length} items` : "No products found.";
    }

    function renderProductsMini(){
      const root = $("prodListMini");
      root.innerHTML = "";
      for(const p of PRODUCTS.slice(0,50)){
        const el = document.createElement("div");
        el.className = "line";
        el.innerHTML = `
          <div>
            <div style="font-weight:900">${escapeHtml(p.name||"Unnamed")}</div>
            <div class="muted">${escapeHtml(p.category||"Uncategorized")} ‚Ä¢ ${money(p.price)} EGP</div>
          </div>
          <div class="qty"><button>+</button></div>
        `;
        el.querySelector("button").onclick = ()=> addToCart(p);
        root.appendChild(el);
      }
      if(PRODUCTS.length>50){
        const more = document.createElement("div");
        more.className = "mini";
        more.textContent = `Showing 50 of ${PRODUCTS.length}`;
        root.appendChild(more);
      }
    }

    // -------- Cart --------
    function addToCart(p){
      const i = CART.findIndex(x=>x.productId===p.id);
      if(i>=0) CART[i].qty += 1;
      else CART.push({ productId:p.id, name:p.name, price:Number(p.price||0), qty:1, note:"" });
      renderCart();
    }

    function renderCart(){
      const root = $("cartLines");
      root.innerHTML = "";
      for(const l of CART){
        const el = document.createElement("div");
        el.className = "line";
        el.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:900">${escapeHtml(l.name)}</div>
            <div class="muted">${money(l.price)} EGP ‚Ä¢ ${money(l.price*l.qty)} EGP</div>
            <div style="margin-top:8px">
              <label style="margin:0 0 6px">Item note (optional)</label>
              <input class="input" data-note="${escapeHtml(l.productId)}" placeholder="e.g. no onions" value="${escapeHtml(l.note||"")}"/>
            </div>
          </div>
          <div class="qty">
            <button data-dec="${escapeHtml(l.productId)}">‚àí</button>
            <div class="n">${l.qty}</div>
            <button data-inc="${escapeHtml(l.productId)}">+</button>
          </div>
        `;
        root.appendChild(el);
      }
      // qty handlers
      root.querySelectorAll("button[data-inc]").forEach(b=>{
        b.onclick = ()=>{
          const pid = b.getAttribute("data-inc");
          const it = CART.find(x=>x.productId===pid); if(!it) return;
          it.qty += 1; renderCart();
        };
      });
      root.querySelectorAll("button[data-dec]").forEach(b=>{
        b.onclick = ()=>{
          const pid = b.getAttribute("data-dec");
          const it = CART.find(x=>x.productId===pid); if(!it) return;
          it.qty -= 1;
          if(it.qty<=0) CART = CART.filter(x=>x.productId!==pid);
          renderCart();
        };
      });
      root.querySelectorAll("input[data-note]").forEach(inp=>{
        inp.oninput = ()=>{
          const pid = inp.getAttribute("data-note");
          const it = CART.find(x=>x.productId===pid); if(!it) return;
          it.note = inp.value;
        };
      });

      $("btnClear").disabled = CART.length===0;
      recalc();
    }

    function recalc(){
      const subtotal = CART.reduce((s,l)=> s + (Number(l.price||0)*Number(l.qty||0)), 0);
      const discountPct = Math.max(0, Number(($("discount").value||"0").replace(",",".")) || 0);
      const discount = subtotal * (discountPct/100);

      const service = Math.max(0, (subtotal - discount) * (POS_SETTINGS.serviceRate/100));
      const tax = Math.max(0, (subtotal - discount + service) * (POS_SETTINGS.taxRate/100));
      const total = Math.max(0, subtotal - discount + service + tax);

      $("tSubtotal").textContent = money(subtotal);
      $("tDiscount").textContent = money(discount);
      $("tService").textContent = money(service);
      $("tTax").textContent = money(tax);
      $("tTotal").textContent = money(total);

      $("cartMeta").textContent = `${CART.reduce((s,l)=>s+Number(l.qty||0),0)} items`;
      $("cartEmpty").classList.toggle("hidden", CART.length>0);
      $("btnPay").disabled = CART.length===0 || total<=0;
    }

    $("discount").oninput = recalc;
    $("btnClear").onclick = ()=>{ CART = []; $("discount").value=""; $("afterPayHint").textContent=""; renderCart(); };

    // -------- Checkout --------
    function renderCheckoutSummary(){
      const subtotal = CART.reduce((s,l)=> s + (Number(l.price||0)*Number(l.qty||0)), 0);
      const discountPct = Math.max(0, Number(($("discount").value||"0").replace(",",".")) || 0);
      const discount = subtotal * (discountPct/100);
      const service = Math.max(0, (subtotal - discount) * (POS_SETTINGS.serviceRate/100));
      const tax = Math.max(0, (subtotal - discount + service) * (POS_SETTINGS.taxRate/100));
      const total = Math.max(0, subtotal - discount + service + tax);

      $("coMeta").textContent = `${CART.reduce((s,l)=>s+Number(l.qty||0),0)} items`;
      $("coSubtotal").textContent = money(subtotal);
      $("coDiscount").textContent = money(discount);
      $("coService").textContent = money(service);
      $("coTax").textContent = money(tax);
      $("coTotal").textContent = money(total);

      $("coLines").innerHTML = "";
      for(const l of CART){
        const row = document.createElement("div");
        row.className = "totrow";
        row.innerHTML = `<span>${l.qty}√ó ${escapeHtml(l.name)}${l.note?` <span class="mini">(${escapeHtml(l.note)})</span>`:""}</span><strong>${money(l.price*l.qty)}</strong>`;
        $("coLines").appendChild(row);
      }
      $("coHint").textContent = "";
    }

    $("btnPay").onclick = ()=>{
      $("coCustomer").value = "";
      $("coOrderNote").value = "";
      renderCheckoutSummary();
      openDrawer("checkoutDrawer", true);
    };

    $("coPayMethods").onclick = (e)=>{
      const el = e.target.closest(".pm"); if(!el) return;
      document.querySelectorAll("#coPayMethods .pm").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      PAY_METHOD = el.getAttribute("data-m");
    };

    $("btnCloseCheckout").onclick = ()=> openDrawer("checkoutDrawer", false);
    $("btnEditCart").onclick = ()=> openDrawer("checkoutDrawer", false);

    $("btnConfirmPay").onclick = async ()=>{
      if(!BRAND_ID){ toast("Not ready","Sign in first."); return; }
      if(CART.length===0){ toast("Empty cart","Add items first."); return; }

      const subtotal = CART.reduce((s,l)=> s + (Number(l.price||0)*Number(l.qty||0)), 0);
      const discountPct = Math.max(0, Number(($("discount").value||"0").replace(",",".")) || 0);
      const discount = subtotal * (discountPct/100);
      const service = Math.max(0, (subtotal - discount) * (POS_SETTINGS.serviceRate/100));
      const tax = Math.max(0, (subtotal - discount + service) * (POS_SETTINGS.taxRate/100));
      const total = Math.max(0, subtotal - discount + service + tax);

      $("btnConfirmPay").disabled = true;
      $("coHint").textContent = "Processing‚Ä¶";
      try{
        const { ordersCol, runtimeCustomerDoc, countersDoc } = basePaths(BRAND_ID);

        const orderNo = await runTransaction(db, async (tx)=>{
          const snap = await tx.get(countersDoc);
          let next = 1000;
          if(snap.exists()) next = Number(snap.data()?.nextOrderNo||1000);
          const newNo = next + 1;
          tx.set(countersDoc, { nextOrderNo: newNo, updatedAt: serverTimestamp() }, { merge:true });
          return newNo;
        });

        const order = {
          brandId: BRAND_ID,
          orderNo,
          brandName: BRAND?.name || BRAND_ID,
          brandLogoUrl: BRAND?.logoUrl || "",
          status: "preparing",
          items: CART.map(l=>({
            productId: l.productId,
            name: l.name,
            qty: Number(l.qty||0),
            price: Number(l.price||0),
            note: (l.note||"").trim() || null
          })),
          orderNote: ($("coOrderNote").value||"").trim() || null,
          customerName: ($("coCustomer").value||"").trim() || null,
          totals: {
            subtotal: Number(subtotal.toFixed(2)),
            discountPct: Number(discountPct.toFixed(2)),
            discount: Number(discount.toFixed(2)),
            serviceRate: Number(POS_SETTINGS.serviceRate||0),
            service: Number(service.toFixed(2)),
            taxRate: Number(POS_SETTINGS.taxRate||0),
            tax: Number(tax.toFixed(2)),
            total: Number(total.toFixed(2))
          },
          payment: { method: PAY_METHOD, paidAt: serverTimestamp() },
          meta: {
            source: "pos",
            role: ROLE,
            staffUsername: STAFF?.username || null
          },
          timestamps: {
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            completedAt: null,
            cancelledAt: null
          }
        };

        const ref = await addDoc(ordersCol, order);

        await setDoc(runtimeCustomerDoc, {
          lastPaidOrderId: ref.id,
          lastPaidAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        const receiptUrl = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(ref.id)}`;
        $("afterPayHint").innerHTML = `‚úÖ Order <b>#${orderNo}</b> sent. Receipt: <code>${escapeHtml(receiptUrl)}</code>`;
        toast("Paid & sent", `Order #${orderNo}`);

        CART = [];
        $("discount").value = "";
        renderCart();
        openDrawer("checkoutDrawer", false);
      }catch(e){
        console.error(e);
        toast("Payment failed", e?.message || "Could not create order.");
        $("coHint").textContent = e?.message || "Failed.";
      }finally{
        $("btnConfirmPay").disabled = false;
      }
    };

    // -------- Orders list + actions --------
    function watchOrders(){
      if(unsubOrders) unsubOrders();
      const { ordersCol } = basePaths(BRAND_ID);
      const q = query(ordersCol, orderBy("timestamps.createdAt","desc"), limit(50));
      unsubOrders = onSnapshot(q, (qs)=>{
        window.__ordersCache = [];
        qs.forEach(d=> window.__ordersCache.push({ id:d.id, ...d.data() }));
        if($("ordersDrawer").style.display==="flex") renderOrders();
      });
    }

    function renderOrders(){
      const status = $("ordStatus").value || "";
      const list = (window.__ordersCache||[]).filter(o=> !status || o.status===status);

      const root = $("ordersList");
      root.innerHTML = "";
      for(const o of list){
        const total = o?.totals?.total ?? 0;
        const pm = o?.payment?.method || "‚Äî";
        const cn = o?.customerName ? ` ‚Ä¢ ${escapeHtml(o.customerName)}` : "";
        const card = document.createElement("div");
        card.className = "line";
        card.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:900">#${escapeHtml(String(o.orderNo||o.id))}</div>
            <div class="muted">${escapeHtml(o.status||"‚Äî")} ‚Ä¢ ${money(total)} EGP ‚Ä¢ ${escapeHtml(pm)}${cn}</div>
          </div>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn" data-receipt="${o.id}">Receipt</button>
            <button class="btn danger" data-cancel="${o.id}" ${o.status==="cancelled"?"disabled":""}>Cancel</button>
            <button class="btn primary" data-refund="${o.id}">Refund</button>
          </div>
        `;
        root.appendChild(card);
      }
      if(!list.length){
        root.innerHTML = `<div class="mini">No orders.</div>`;
      }

      root.querySelectorAll("button[data-receipt]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute("data-receipt");
          const url = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(id)}`;
          window.open(url, "_blank");
        };
      });
      root.querySelectorAll("button[data-cancel]").forEach(b=>{
        b.onclick = ()=> cancelOrder(b.getAttribute("data-cancel"));
      });
      root.querySelectorAll("button[data-refund]").forEach(b=>{
        b.onclick = ()=> openRefund(b.getAttribute("data-refund"));
      });
    }

    async function cancelOrder(orderId){
      try{
        const ref = doc(db, `brands/${BRAND_ID}/orders/${orderId}`);
        await updateDoc(ref, {
          status:"cancelled",
          "timestamps.cancelledAt": serverTimestamp(),
          "timestamps.updatedAt": serverTimestamp()
        });
        toast("Cancelled","Order updated.");
      }catch(e){
        console.error(e);
        toast("Cancel failed", e?.message || "");
      }
    }

    // -------- Refund (full or by items) --------
    let __refundOrder = null;
    let __refundMode = "full";

    function openRefund(orderId){
      const o = (window.__ordersCache||[]).find(x=>x.id===orderId);
      if(!o){ toast("Not found","Order missing."); return; }
      __refundOrder = o;
      __refundMode = "full";

      $("rfMeta").textContent = `Refund for Order #${o.orderNo||o.id} ‚Ä¢ ${money(o?.totals?.total||0)} EGP`;
      $("rfModeFull").classList.add("active");
      $("rfModeItems").classList.remove("active");
      $("rfItemsWrap").classList.add("hidden");
      $("rfItemsWrap").innerHTML = "";
      $("rfHint").textContent = "";

      const items = Array.isArray(o.items) ? o.items : [];
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.innerHTML = `<div class="card-h"><div><h2>Select items</h2><div class="mini">Choose qty to refund per item</div></div></div><div class="card-b" id="rfItems"></div>`;
      const box = wrap.querySelector("#rfItems");
      for(const it of items){
        const row = document.createElement("div");
        row.className = "line";
        row.dataset.pid = String(it.productId||it.name||"");
        row.dataset.max = String(it.qty||0);
        row.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:900">${escapeHtml(it.name||"Item")}</div>
            <div class="muted">Bought: <b>${escapeHtml(it.qty||0)}</b> ‚Ä¢ ${money(it.price||0)} EGP</div>
          </div>
          <div class="qty">
            <button class="rfDec">‚àí</button>
            <div class="n">0</div>
            <button class="rfInc">+</button>
          </div>
        `;
        row.querySelector(".rfInc").onclick = ()=>{
          const max = Number(row.dataset.max||0);
          const nEl = row.querySelector(".n");
          let n = Number(nEl.textContent||0);
          n = Math.min(max, n+1);
          nEl.textContent = String(n);
        };
        row.querySelector(".rfDec").onclick = ()=>{
          const nEl = row.querySelector(".n");
          let n = Number(nEl.textContent||0);
          n = Math.max(0, n-1);
          nEl.textContent = String(n);
        };
        box.appendChild(row);
      }
      $("rfItemsWrap").appendChild(wrap);

      openDrawer("refundDrawer", true);
    }

    $("rfModeFull").onclick = ()=>{
      __refundMode = "full";
      $("rfModeFull").classList.add("active");
      $("rfModeItems").classList.remove("active");
      $("rfItemsWrap").classList.add("hidden");
      $("rfHint").textContent = "";
    };
    $("rfModeItems").onclick = ()=>{
      __refundMode = "items";
      $("rfModeItems").classList.add("active");
      $("rfModeFull").classList.remove("active");
      $("rfItemsWrap").classList.remove("hidden");
      $("rfHint").textContent = "Select quantities to refund, then confirm.";
    };

    $("btnCloseRefund").onclick = ()=> openDrawer("refundDrawer", false);
    $("btnCancelRefund").onclick = ()=> openDrawer("refundDrawer", false);

    $("btnConfirmRefund").onclick = async ()=>{
      if(!__refundOrder) return;
      try{
        const ref = doc(db, `brands/${BRAND_ID}/orders/${__refundOrder.id}`);
        const refund = { mode: __refundMode, at: serverTimestamp() };

        if(__refundMode === "full"){
          refund.full = true;
        }else{
          const selected = [];
          $("rfItemsWrap").querySelectorAll(".line").forEach(row=>{
            const pid = row.dataset.pid;
            const qty = Number(row.querySelector(".n")?.textContent||0);
            if(qty>0){
              const it = (__refundOrder.items||[]).find(x=>String(x.productId||x.name)===pid) || {};
              selected.push({
                productId: it.productId || null,
                name: it.name || pid,
                qty,
                unitPrice: Number(it.price||0)
              });
            }
          });
          if(!selected.length){
            toast("Select items","Choose at least 1 item qty.");
            return;
          }
          refund.items = selected;
        }

        await updateDoc(ref, { refund, "timestamps.updatedAt": serverTimestamp() });
        toast("Refund recorded", `Order #${__refundOrder.orderNo||__refundOrder.id}`);
        openDrawer("refundDrawer", false);
      }catch(e){
        console.error(e);
        toast("Refund failed", e?.message || "");
      }
    };

    // -------- Settings --------
    $("btnOpenSettings").onclick = ()=> openDrawer("settingsDrawer", true);
    $("btnCloseSettings").onclick = ()=> openDrawer("settingsDrawer", false);

    $("btnResetSettings").onclick = ()=>{
      $("setTaxRate").value = String(POS_SETTINGS.taxRate||0);
      $("setServiceRate").value = String(POS_SETTINGS.serviceRate||0);
      $("settingsMsg").textContent = "";
    };

    $("btnSaveSettings").onclick = async ()=>{
      if(!BRAND_ID){ toast("Not ready","Sign in first."); return; }
      const taxRate = Math.max(0, Number(($("setTaxRate").value||"0").replace(",",".")) || 0);
      const serviceRate = Math.max(0, Number(($("setServiceRate").value||"0").replace(",",".")) || 0);
      $("btnSaveSettings").disabled = true;
      $("settingsMsg").textContent = "Saving‚Ä¶";
      try{
        const { settingsPosDoc } = basePaths(BRAND_ID);
        await setDoc(settingsPosDoc, { taxRate, serviceRate, updatedAt: serverTimestamp() }, { merge:true });
        toast("Settings saved", `Tax ${taxRate}% ‚Ä¢ Service ${serviceRate}%`);
        $("settingsMsg").textContent = "‚úÖ Saved";
        await loadPosSettings();
      }catch(e){
        console.error(e);
        $("settingsMsg").textContent = e?.message || "Save failed.";
      }finally{
        $("btnSaveSettings").disabled = false;
      }
    };

    // -------- Products manager --------
    $("btnOpenProducts").onclick = ()=> openDrawer("productsDrawer", true);
    $("btnCloseProducts").onclick = ()=> openDrawer("productsDrawer", false);
    $("btnResetProduct").onclick = ()=>{
      $("pName").value=""; $("pCat").value=""; $("pPrice").value=""; $("pDesc").value=""; $("pImg").value="";
      $("prodMsg").textContent="";
    };

    $("btnAddProduct").onclick = async ()=>{
      if(!BRAND_ID){ toast("Not ready","Sign in first."); return; }
      const name = ($("pName").value||"").trim();
      const category = ($("pCat").value||"").trim() || "Uncategorized";
      const price = Number(($("pPrice").value||"0").replace(",",".")) || 0;
      const desc = ($("pDesc").value||"").trim() || null;
      if(!name || price<=0){ toast("Missing info","Name + price required."); return; }

      $("btnAddProduct").disabled = true;
      $("prodMsg").textContent = "Saving‚Ä¶";
      try{
        const { productsCol } = basePaths(BRAND_ID);
        let imageUrl = "";
        const f = $("pImg").files?.[0];
        if(f){
          const key = `brands/${BRAND_ID}/products/${Date.now()}_${f.name}`;
          const r = sRef(storage, key);
          await uploadBytes(r, f);
          imageUrl = await getDownloadURL(r);
        }
        await addDoc(productsCol, {
          name, category, price, desc,
          imageUrl: imageUrl || "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        toast("Product added", name);
        $("prodMsg").textContent = "‚úÖ Added";
        $("pName").value=""; $("pPrice").value=""; $("pDesc").value=""; $("pImg").value="";
      }catch(e){
        console.error(e);
        $("prodMsg").textContent = e?.message || "Failed.";
      }finally{
        $("btnAddProduct").disabled = false;
      }
    };

    // -------- Orders modal --------
    $("btnOpenOrders").onclick = ()=>{ openDrawer("ordersDrawer", true); renderOrders(); };
    $("btnCloseOrders").onclick = ()=> openDrawer("ordersDrawer", false);
    $("ordStatus").onchange = renderOrders;

    // -------- Auth modal tabs --------
    $("btnOpenAuth").onclick = ()=> openDrawer("authDrawer", true);
    $("btnCloseAuth").onclick = ()=> openDrawer("authDrawer", false);

    $("authTabs").onclick = (e)=>{
      const chip = e.target.closest(".chip"); if(!chip) return;
      document.querySelectorAll("#authTabs .chip").forEach(x=>x.classList.remove("active"));
      chip.classList.add("active");
      const tab = chip.getAttribute("data-tab");
      $("tabOwner").classList.toggle("hidden", tab!=="owner");
      $("tabStaff").classList.toggle("hidden", tab!=="staff");
    };

    // SHA-256 for staff PIN (matches dashboard pinHash)
    async function sha256(text){
      const enc = new TextEncoder().encode(String(text));
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function setReady(roleLabel){
      $("btnOpenSettings").disabled = false;
      $("btnOpenProducts").disabled = false;
      $("btnOpenOrders").disabled = false;
      $("btnSignOut").disabled = false;
      $("btnOpenAuth").disabled = true;

      setPill("ok", `Ready ‚Ä¢ ${roleLabel}`);
      openDrawer("authDrawer", false);

      await ensureBrandShell(BRAND_ID);
      await loadBrand(BRAND_ID);
      await loadPosSettings();
      watchProducts();
      watchOrders();
    }

    // Owner register/login
    $("btnRegister").onclick = async ()=>{
      const brandId = ($("brandId").value||"").trim();
      const email = ($("email").value||"").trim();
      const pass = ($("password").value||"").trim();
      if(!brandId){ $("authMsg").textContent = "Brand ID required."; return; }
      if(!email || !pass){ $("authMsg").textContent = "Email + password required."; return; }
      $("authMsg").textContent = "Creating‚Ä¶";
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        BRAND_ID = brandId;
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        ROLE = "owner";
        STAFF = null;
        await setReady("owner");
      }catch(e){
        console.error(e);
        $("authMsg").textContent = e?.message || "Failed.";
      }
    };

    $("btnLogin").onclick = async ()=>{
      const brandId = ($("brandId").value||"").trim();
      const email = ($("email").value||"").trim();
      const pass = ($("password").value||"").trim();
      if(!brandId){ $("authMsg").textContent = "Brand ID required."; return; }
      if(!email || !pass){ $("authMsg").textContent = "Email + password required."; return; }
      $("authMsg").textContent = "Signing in‚Ä¶";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        BRAND_ID = brandId;
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        ROLE = "owner";
        STAFF = null;
        await setReady("owner");
      }catch(e){
        console.error(e);
        $("authMsg").textContent = e?.message || "Failed.";
      }
    };

    // Staff login (username+PIN)
    $("btnStaffLogin").onclick = async ()=>{
      const brandId = ($("brandId").value||"").trim();
      const username = ($("staffUser").value||"").trim();
      const pin = ($("staffPin").value||"").trim();
      if(!brandId){ $("staffMsg").textContent = "Brand ID required."; return; }
      if(!username || !pin){ $("staffMsg").textContent = "Username + PIN required."; return; }
      $("staffMsg").textContent = "Checking‚Ä¶";

      try{
        BRAND_ID = brandId;
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        await ensureBrandShell(BRAND_ID);

        const { staffCol } = basePaths(BRAND_ID);
        const qs = await getDocs(query(staffCol, where("username","==", username), limit(1)));
        if(qs.empty){ $("staffMsg").textContent = "Invalid PIN or inactive user."; return; }
        const doc1 = qs.docs[0];
        const data = doc1.data()||{};
        if(data.active === false){ $("staffMsg").textContent = "Invalid PIN or inactive user."; return; }

        const enteredHash = await sha256(pin);
        const ok = (data.pinHash && data.pinHash === enteredHash) || (data.pin && String(data.pin)===String(pin));
        if(!ok){ $("staffMsg").textContent = "Invalid PIN or inactive user."; return; }

        ROLE = "staff";
        STAFF = { id: doc1.id, ...data };
        await setReady("staff");
      }catch(e){
        console.error(e);
        $("staffMsg").textContent = e?.message || "Failed.";
      }
    };

    // Sign out
    $("btnSignOut").onclick = async ()=>{
      try{ await signOut(auth); }catch(_){}
      ROLE = "guest"; STAFF = null;
      BRAND_ID = "";
      BRAND = null;
      localStorage.removeItem("luma_pos_brandId");
      if(unsubProducts) unsubProducts();
      if(unsubOrders) unsubOrders();
      PRODUCTS = []; CART = [];
      $("productsGrid").innerHTML = "";
      $("prodListMini").innerHTML = "";
      $("ordersList").innerHTML = "";
      $("afterPayHint").textContent = "";
      $("discount").value = "";
      renderCart();

      $("btnOpenSettings").disabled = true;
      $("btnOpenProducts").disabled = true;
      $("btnOpenOrders").disabled = true;
      $("btnSignOut").disabled = true;
      $("btnOpenAuth").disabled = false;

      $("brandTitle").textContent = "POS";
      $("brandLogoBox").textContent = "L";
      setPill("warn","Not signed in");
      toast("Signed out","See you.");
    };

    // Restore last brand id for convenience
    const lastBrand = localStorage.getItem("luma_pos_brandId") || "";
    if(lastBrand){ $("brandId").value = lastBrand; }

    // Live auth state: if owner is already signed in, user still needs Brand ID to load correct paths.
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      // If owner signed in, keep owner role but do not auto-ready unless brandId is available
      const bid = ($("brandId").value||"").trim() || (localStorage.getItem("luma_pos_brandId")||"");
      if(bid){
        BRAND_ID = bid;
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        ROLE = "owner";
        STAFF = null;
        await setReady("owner");
      }else{
        setPill("warn","Signed in (owner) ‚Ä¢ select Brand ID");
      }
    });

    // Filters
    $("q").oninput = renderProducts;
    $("cat").onchange = renderProducts;

  </script>
</body>
</html>
