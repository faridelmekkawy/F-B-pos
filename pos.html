<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma — POS</title>
  <link rel="icon" href="data:,">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}
    .wrap{max-width:1400px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:14px;padding:14px 16px;border:1px solid var(--border);
      background:var(--panel);border-radius:18px;box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:10;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
      min-width:280px;
    }
    .logo{
      width:40px;height:40px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-strong));
      display:grid;place-items:center;color:#fff;font-weight:800;
      overflow:hidden;border:1px solid rgba(255,255,255,.25);
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:16px;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel-soft);color:var(--muted);display:inline-flex;gap:8px;align-items:center;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--muted)}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--danger)}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid var(--border);background:var(--panel);
      padding:10px 12px;border-radius:12px;cursor:pointer;
      font-weight:700;font-size:13px;display:inline-flex;align-items:center;gap:8px;
      transition:.15s transform,.15s background,.15s border-color;
    }
    .btn:hover{transform:translateY(-1px);border-color:#d1d5db}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-strong);border-color:var(--accent-strong)}
    .btn.danger{background:#fff;border-color:#fecaca;color:#b91c1c}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .grid{
      display:grid;grid-template-columns: 1.6fr .9fr;
      gap:16px;margin-top:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
      .topbar{position:relative;top:auto}
    }

    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card-h h2{font-size:14px}
    .card-h .mini{font-size:12px;color:var(--muted)}
    .card-b{padding:14px 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{
      display:flex;flex-direction:column;gap:6px;
      min-width:180px;flex:1;
    }
    .field label{font-size:12px;color:var(--muted);font-weight:600}
    .input, .select, textarea{
      width:100%;
      padding:11px 12px;border-radius:12px;
      border:1px solid var(--border);background:#fff;
      font:inherit;font-size:13px;
      outline:none;
    }
    textarea{min-height:74px;resize:vertical}
    .hint{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel-soft);font-size:12px;font-weight:700;cursor:pointer;
    }
    .chip.active{background:var(--accent-soft);border-color:#bfdbfe;color:var(--accent-strong)}
    .products{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:12px;margin-top:12px;
    }
    @media (max-width: 1100px){ .products{grid-template-columns:repeat(3,minmax(0,1fr));} }
    @media (max-width: 760px){ .products{grid-template-columns:repeat(2,minmax(0,1fr));} }
    .p{
      border:1px solid var(--border);border-radius:16px;
      background:linear-gradient(180deg,#fff, var(--panel-soft));
      overflow:hidden;cursor:pointer;
      transition:.12s transform,.12s border-color;
      display:flex;flex-direction:column;min-height:150px;
    }
    .p:hover{transform:translateY(-1px);border-color:#d1d5db}
    .pimg{height:86px;background:#eef2ff;display:grid;place-items:center;overflow:hidden}
    .pimg img{width:100%;height:100%;object-fit:cover}
    .pmeta{padding:10px 10px 12px}
    .pname{font-weight:800;font-size:13px}
    .pcat{font-size:12px;color:var(--muted);margin-top:2px}
    .pprice{margin-top:8px;font-weight:900}
    .empty{
      padding:20px;border:1px dashed var(--border);border-radius:16px;
      background:var(--panel-soft);color:var(--muted);
      text-align:center;
    }

    .cartlist{display:flex;flex-direction:column;gap:10px}
    .line{
      border:1px solid var(--border);border-radius:16px;background:#fff;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
    }
    .line .title{font-weight:800;font-size:13px}
    .line .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .qty{
      display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:wrap;
    }
    .qty button{
      width:34px;height:34px;border-radius:12px;border:1px solid var(--border);
      background:var(--panel-soft);cursor:pointer;font-weight:900;
    }
    .qty .n{min-width:22px;text-align:center;font-weight:900}
    .line textarea{min-height:54px}
    .totals{
      border-top:1px solid var(--border);
      margin-top:12px;padding-top:12px;
      display:flex;flex-direction:column;gap:8px;
      font-size:13px;
    }
    .totrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .totrow strong{font-weight:900}
    .bigpay{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .paymethods{display:flex;gap:8px;flex-wrap:wrap}
    .pm{
      padding:9px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--panel-soft);font-weight:800;font-size:12px;cursor:pointer;
    }
    .pm.active{background:var(--accent-soft);border-color:#bfdbfe;color:var(--accent-strong)}
    .toast{
      position:fixed;right:16px;bottom:16px;z-index:100;
      min-width:280px;max-width:420px;
      background:#0b1220;color:#fff;
      border-radius:16px;padding:12px 14px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      display:none;
    }
    .toast .t{font-weight:900}
    .toast .m{font-size:12px;opacity:.85;margin-top:2px}
    .drawer{
      position:fixed;inset:0;z-index:50;display:none;
      background:rgba(15,23,42,.55);
      align-items:flex-end;justify-content:center;
      padding:16px;
    }
    .sheet{
      width:min(860px, 100%);
      background:var(--panel);
      border-radius:20px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
      max-height:88vh;
      display:flex;flex-direction:column;
    }
    .sheet .sh{
      padding:14px 16px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .sheet .sh h3{font-size:14px}
    .sheet .sb{padding:14px 16px;overflow:auto}
    .footer{
      margin:16px auto 4px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    .footer b{color:var(--ink)}
    .hidden{display:none !important}
    code{background:var(--panel-soft);border:1px solid var(--border);padding:2px 6px;border-radius:9px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="brandLogoBox"><span>LU</span></div>
        <div>
          <h1>POS</h1>
          <div class="sub" id="brandSub">Not signed in</div>
        </div>
      </div>

      <div class="pill" id="authPill"><span class="dot warn"></span><span id="authPillText">Offline / Not ready</span></div>

      <div class="actions">
        <button class="btn" id="btnOpenProducts">Products</button>
        <button class="btn" id="btnOpenRecent">Recent orders</button>
        <button class="btn ghost" id="btnSignOut">Sign out</button>
      </div>
    </div>

    <!-- AUTH GATE -->
    <div class="card" id="authCard" style="margin-top:16px;">
      <div class="card-h">
        <div>
          <h2>Sign in to POS</h2>
          <div class="mini">Use owner (email/password) or staff (username + PIN). Everything is under <code>brands/{brandId}</code>.</div>
        </div>
        <button class="btn primary" id="btnOpenAuth">Open login</button>
      </div>
      <div class="card-b">
        <div class="row">
          <div class="field" style="min-width:260px;flex:1.2">
            <label>Brand ID</label>
            <input class="input" id="brandId" placeholder="e.g. oudies" autocomplete="off"/>
            <div class="hint">No URL params. Brand context is selected here then stored locally.</div>
          </div>
          <div class="field" style="min-width:240px">
            <label>Status</label>
            <div class="pill" style="height:44px;align-items:center;justify-content:flex-start">
              <span class="dot warn"></span><span id="authMsgInline">Not signed in</span>
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          If staff login fails, make sure the staff user is <b>active</b> and PIN matches the dashboard’s hashing method.
        </div>
      </div>
    </div>

    <!-- AUTH MODAL -->
    <div class="drawer" id="authDrawer">
      <div class="sheet">
        <div class="sh">
          <h3>Login</h3>
          <button class="btn" id="btnCloseAuth">Close</button>
        </div>
        <div class="sb">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="chips" id="authTabs">
              <div class="chip active" data-tab="owner">Owner</div>
              <div class="chip" data-tab="staff">Staff</div>
            </div>
            <div class="hint">Brand: <code id="brandCode">—</code></div>
          </div>

          <!-- OWNER -->
          <div id="tabOwner" style="margin-top:12px">
            <div class="card">
              <div class="card-h"><h2>Owner login</h2><div class="mini">Firebase Auth (email + password)</div></div>
              <div class="card-b">
                <div class="row">
                  <div class="field">
                    <label>Email</label>
                    <input class="input" id="email" placeholder="you@company.com" autocomplete="email"/>
                  </div>
                  <div class="field">
                    <label>Password</label>
                    <input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password"/>
                  </div>
                </div>
                <div class="row" style="margin-top:10px;justify-content:flex-end">
                  <button class="btn" id="btnRegister">Register</button>
                  <button class="btn primary" id="btnLogin">Sign in</button>
                </div>
                <div class="hint" id="authMsg" style="margin-top:10px"></div>
              </div>
            </div>
          </div>

          <!-- STAFF -->
          <div id="tabStaff" class="hidden" style="margin-top:12px">
            <div class="card">
              <div class="card-h"><h2>Staff login</h2><div class="mini">Username + PIN (from Vendor Dashboard → Staff)</div></div>
              <div class="card-b">
                <div class="row">
                  <div class="field">
                    <label>Username</label>
                    <input class="input" id="staffUser" placeholder="e.g. cashier1" autocomplete="off"/>
                  </div>
                  <div class="field">
                    <label>PIN</label>
                    <input class="input" id="staffPin" placeholder="4-6 digits" inputmode="numeric" autocomplete="off"/>
                  </div>
                </div>
                <div class="row" style="margin-top:10px;justify-content:flex-end">
                  <button class="btn primary" id="btnStaffLogin">Enter POS</button>
                </div>
                <div class="hint" id="staffMsg" style="margin-top:10px"></div>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:12px">
            Tip: You can keep this POS open on a cashier tablet. Products and orders sync live.
          </div>
        </div>
      </div>
    </div>

    <!-- APP --><!-- APP -->
    <div id="app" class="hidden">
      <div class="grid">

        <!-- PRODUCTS -->
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Menu</h2>
              <div class="mini" id="menuMeta">0 products</div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <input class="input" id="search" placeholder="Search products…" style="max-width:280px"/>
            </div>
          </div>
          <div class="card-b">
            <div class="chips" id="catChips"></div>
            <div id="products" class="products"></div>
            <div id="prodEmpty" class="empty hidden">No products yet. Add some in <b>Products</b>.</div>
          </div>
        </div>

        <!-- CART -->
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Cart</h2>
              <div class="mini" id="cartMeta">0 items</div>
            </div>
            <button class="btn" id="btnClearCart">Clear</button>
          </div>
          <div class="card-b">
            <div class="cartlist" id="cart"></div>
            <div id="cartEmpty" class="empty">Tap items from the menu to add them here.</div>

            <div class="row" style="margin-top:12px">
              <div class="field" style="min-width:140px">
                <label>Discount</label>
                <input class="input" id="discount" placeholder="0" inputmode="decimal"/>
              </div>
              <div class="field" style="min-width:140px">
                <label>Tax</label>
                <input class="input" id="tax" placeholder="0" inputmode="decimal"/>
              </div>
              <div class="field" style="min-width:180px;flex:1.4">
                <label>Customer name (optional)</label>
                <input class="input" id="customerName" placeholder="Walk-in"/>
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>Kitchen note (order-level)</label>
              <textarea id="orderNote" placeholder="e.g. Serve hot, extra napkins…"></textarea>
            </div>

            <div class="totals">
              <div class="totrow"><span>Subtotal</span><strong id="tSubtotal">0.00</strong></div>
              <div class="totrow"><span>Discount</span><strong id="tDiscount">0.00</strong></div>
              <div class="totrow"><span>Tax</span><strong id="tTax">0.00</strong></div>
              <div class="totrow" style="font-size:15px"><span>Total</span><strong id="tTotal">0.00</strong></div>
            </div>

            <div class="bigpay">
              <div class="paymethods" id="payMethods">
                <div class="pm active" data-m="cash">Cash</div>
                <div class="pm" data-m="card">Card</div>
                <div class="pm" data-m="wallet">Wallet</div>
              </div>
              <button class="btn primary" id="btnPay" disabled>Pay & Send to Kitchen</button>
            </div>

            <div class="hint" id="afterPayHint" style="margin-top:10px"></div>
          </div>
        </div>

      </div>

      <div class="footer">Powered by <b>Luma</b></div>
    </div>

  </div>

  <!-- PRODUCTS DRAWER -->
  <div class="drawer" id="productsDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Products manager</h3>
        <button class="btn" id="btnCloseProducts">Close</button>
      </div>
      <div class="sb">
        <div class="row">
          <div class="field">
            <label>Name</label>
            <input class="input" id="pName" placeholder="e.g. Burger"/>
          </div>
          <div class="field">
            <label>Category</label>
            <input class="input" id="pCat" placeholder="e.g. Sandwiches"/>
          </div>
          <div class="field">
            <label>Price</label>
            <input class="input" id="pPrice" placeholder="0" inputmode="decimal"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:1.3">
            <label>Description (optional)</label>
            <input class="input" id="pDesc" placeholder="Short description"/>
          </div>
          <div class="field">
            <label>Image (optional)</label>
            <input class="input" id="pImg" type="file" accept="image/*"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button class="btn" id="btnClearP">Clear</button>
          <button class="btn primary" id="btnSaveP">Save product</button>
        </div>

        <div class="hr" style="height:1px;background:var(--border);margin:14px 0"></div>
        <div class="hint" id="pmMsg"></div>
        <div id="pmList" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- RECENT ORDERS DRAWER -->
  <div class="drawer" id="recentDrawer">
    <div class="sheet">
      <div class="sh">
        <h3>Recent orders</h3>
        <button class="btn" id="btnCloseRecent">Close</button>
      </div>
      <div class="sb">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="hint">Quick operations: cancel / refund / open receipt.</div>
          <button class="btn" id="btnRefreshRecent">Refresh</button>
        </div>
        <div id="recentList" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t" id="toastT">Saved</div>
    <div class="m" id="toastM">Done</div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, orderBy, limit,
      getDocs, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ✅ Same credentials block as your dashboard (index 15)
    const firebaseConfig = {
      apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp2mY7UPG",
      authDomain:"events-339ce.firebaseapp.com",
      projectId:"events-339ce",
      storageBucket:"events-339ce.firebasestorage.app",
      messagingSenderId:"175601544315",
      appId:"1:175601544315:web:00c94b4affa972b3a286de"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const money = (n)=> (Number(n||0)).toFixed(2);
    const nowISO = ()=> new Date().toISOString();
    function toast(t,m){
      $("toastT").textContent = t;
      $("toastM").textContent = m || "";
      $("toast").style.display = "block";
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> $("toast").style.display="none", 2600);
    }
    function setPill(state, text){
      const dot = $("authPill").querySelector(".dot");
      dot.classList.remove("ok","warn","bad");
      dot.classList.add(state);
      $("authPillText").textContent = text;
      const inline = document.getElementById("authMsgInline");
      if(inline) inline.textContent = text;
    }
    function needBrandId(){
      const bid = ($("brandId").value||"").trim();
      if(!bid){ toast("Brand ID required","Enter a Brand ID first."); $("brandId").focus(); }
      return bid;
    }
    function basePaths(brandId){
      return {
        brandDoc: doc(db, `brands/${brandId}`),
        productsCol: collection(db, `brands/${brandId}/products`),
        ordersCol: collection(db, `brands/${brandId}/orders`),
        staffCol: collection(db, `brands/${brandId}/staff`),
        runtimeCustomerDoc: doc(db, `brands/${brandId}/runtime/customerDisplay`)
      };
    }

    
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(String(str));
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
// ---------- state ----------
    let BRAND_ID = "";
    let BRAND = null; // {name, logoUrl}
    let ROLE = "owner"; // owner|cashier
    let STAFF = null; // {username, role}
    let PRODUCTS = []; // {id,name,category,price,imageUrl,desc}
    let FILTER_CAT = "All";
    let SEARCH = "";
    let CART = []; // {productId,name,price,qty,note}
    let PAY_METHOD = "cash";

    // ---------- UI: basics ----------
    function showApp(yes){
      $("authCard").classList.toggle("hidden", yes);
      $("app").classList.toggle("hidden", !yes);
    }

    function setBrandHeader(){
      const sub = BRAND
        ? `${BRAND.name || BRAND_ID} • ${ROLE}${STAFF?.username?` (${STAFF.username})`:``}`
        : `Brand: ${BRAND_ID} • ${ROLE}${STAFF?.username?` (${STAFF.username})`:``}`;
      $("brandSub").textContent = sub;

      const box = $("brandLogoBox");
      box.innerHTML = "";
      if(BRAND?.logoUrl){
        const img = document.createElement("img");
        img.src = BRAND.logoUrl;
        img.alt = "Brand";
        box.appendChild(img);
      }else{
        const span = document.createElement("span");
        span.textContent = "LU";
        box.appendChild(span);
      }
    }

    function recalc(){
      const subtotal = CART.reduce((s,l)=> s + (Number(l.price||0)*Number(l.qty||0)), 0);
      const discount = Math.max(0, Number(($("discount").value||"0").replace(",",".")) || 0);
      const tax = Math.max(0, Number(($("tax").value||"0").replace(",",".")) || 0);
      const total = Math.max(0, subtotal - discount + tax);

      $("tSubtotal").textContent = money(subtotal);
      $("tDiscount").textContent = money(discount);
      $("tTax").textContent = money(tax);
      $("tTotal").textContent = money(total);

      $("cartMeta").textContent = `${CART.reduce((s,l)=>s+Number(l.qty||0),0)} items`;
      const hasItems = CART.length>0;
      $("cartEmpty").classList.toggle("hidden", hasItems);
      $("btnPay").disabled = !hasItems || total <= 0;
    }

    function renderCart(){
      const root = $("cart");
      root.innerHTML = "";
      for(const l of CART){
        const el = document.createElement("div");
        el.className = "line";
        el.innerHTML = `
          <div>
            <div class="title">${escapeHtml(l.name)}</div>
            <div class="sub">${money(l.price)} × <b>${l.qty}</b> = <b>${money(l.price*l.qty)}</b></div>
            <div style="margin-top:8px">
              <label style="font-size:12px;color:var(--muted);font-weight:600">Item note (optional)</label>
              <textarea data-note="${l.productId}" placeholder="e.g. no onions">${escapeHtml(l.note||"")}</textarea>
            </div>
          </div>
          <div class="qty">
            <button data-dec="${l.productId}">−</button>
            <div class="n">${l.qty}</div>
            <button data-inc="${l.productId}">+</button>
          </div>
        `;
        root.appendChild(el);
      }

      // handlers
      root.querySelectorAll("button[data-inc]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute("data-inc");
          const it = CART.find(x=>x.productId===id);
          if(it){ it.qty++; renderCart(); }
        };
      });
      root.querySelectorAll("button[data-dec]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute("data-dec");
          const it = CART.find(x=>x.productId===id);
          if(it){
            it.qty--;
            if(it.qty<=0) CART = CART.filter(x=>x.productId!==id);
            renderCart();
          }
        };
      });
      root.querySelectorAll("textarea[data-note]").forEach(t=>{
        t.oninput = ()=>{
          const id = t.getAttribute("data-note");
          const it = CART.find(x=>x.productId===id);
          if(it) it.note = t.value;
        };
      });

      recalc();
    }

    function addToCart(p){
      const existing = CART.find(x=>x.productId===p.id);
      if(existing) existing.qty++;
      else CART.push({productId:p.id, name:p.name, price:Number(p.price||0), qty:1, note:""});
      renderCart();
    }

    function renderChips(){
      const cats = ["All", ...Array.from(new Set(PRODUCTS.map(p=>p.category||"Uncategorized")))];
      const root = $("catChips");
      root.innerHTML = "";
      for(const c of cats){
        const el = document.createElement("div");
        el.className = "chip" + (FILTER_CAT===c ? " active":"");
        el.textContent = c;
        el.onclick = ()=>{ FILTER_CAT=c; renderProducts(); };
        root.appendChild(el);
      }
    }

    function renderProducts(){
      const grid = $("products");
      const empty = $("prodEmpty");
      const q = (SEARCH||"").trim().toLowerCase();
      grid.innerHTML = "";

      let list = PRODUCTS.slice();
      if(FILTER_CAT!=="All") list = list.filter(p=>(p.category||"Uncategorized")===FILTER_CAT);
      if(q) list = list.filter(p=> (p.name||"").toLowerCase().includes(q) || (p.category||"").toLowerCase().includes(q));

      $("menuMeta").textContent = `${list.length} products`;
      empty.classList.toggle("hidden", PRODUCTS.length>0);

      for(const p of list){
        const el = document.createElement("div");
        el.className = "p";
        el.innerHTML = `
          <div class="pimg">${p.imageUrl ? `<img src="${escapeAttr(p.imageUrl)}" alt="">` : `<div class="hint">No image</div>`}</div>
          <div class="pmeta">
            <div class="pname">${escapeHtml(p.name||"Unnamed")}</div>
            <div class="pcat">${escapeHtml(p.category||"Uncategorized")}</div>
            <div class="pprice">${money(p.price)} EGP</div>
          </div>
        `;
        el.onclick = ()=> addToCart(p);
        grid.appendChild(el);
      }
    }

    function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

    // ---------- Firestore: bootstrap + realtime ----------
    let unsubProducts = null;

    async function ensureBrandShell(brandId){
      const { brandDoc, runtimeCustomerDoc } = basePaths(brandId);
      const bSnap = await getDoc(brandDoc);
      if(!bSnap.exists()){
        await setDoc(brandDoc, {
          name: brandId,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
      }else{
        await updateDoc(brandDoc, { updatedAt: serverTimestamp() }).catch(()=>{});
      }
      const rSnap = await getDoc(runtimeCustomerDoc);
      if(!rSnap.exists()){
        await setDoc(runtimeCustomerDoc, {
          lastPaidOrderId: null,
          lastPaidAt: null,
          updatedAt: serverTimestamp()
        }, { merge:true });
      }
    }

    async function loadBrand(brandId){
      const { brandDoc } = basePaths(brandId);
      const snap = await getDoc(brandDoc);
      BRAND = snap.exists() ? snap.data() : {name:brandId};
      setBrandHeader();
    }

    function startProductsListener(){
      if(unsubProducts) unsubProducts();
      const { productsCol } = basePaths(BRAND_ID);
      unsubProducts = onSnapshot(productsCol, (qs)=>{
        PRODUCTS = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        // normalize
        PRODUCTS = PRODUCTS.map(p=>({
          ...p,
          name: p.name || "Unnamed",
          category: p.category || "Uncategorized",
          price: Number(p.price||0),
          imageUrl: p.imageUrl || "",
          desc: p.desc || ""
        }));
        renderChips();
        renderProducts();
      }, (err)=>{
        console.error(err);
        setPill("bad","Products listener error");
      });
    }

    // ---------- Auth: owner ----------
    $("btnRegister").onclick = async ()=>{
      const bid = needBrandId(); if(!bid) return;
      const email = ($("email").value||"").trim();
      const pass = ($("password").value||"").trim();
      if(!email || !pass){ $("authMsg").textContent="Enter email + password."; return; }
      $("authMsg").textContent="Registering…";
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
        $("authMsg").textContent="Registered. You can sign in now.";
      }catch(e){
        console.error(e);
        $("authMsg").textContent = e?.message || "Register failed.";
      }
    };

    $("btnLogin").onclick = async ()=>{
      const bid = needBrandId(); if(!bid) return;
      const email = ($("email").value||"").trim();
      const pass = ($("password").value||"").trim();
      if(!email || !pass){ $("authMsg").textContent="Enter email + password."; return; }
      $("authMsg").textContent="Signing in…";
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        $("authMsg").textContent="";
      }catch(e){
        console.error(e);
        $("authMsg").textContent = e?.message || "Login failed.";
      }
    };

    // ---------- Auth: staff username + PIN ----------
    $("btnStaffLogin").onclick = async ()=>{
      const bid = needBrandId(); if(!bid) return;
      const u = ($("staffUser").value||"").trim();
      const pin = ($("staffPin").value||"").trim();
      if(!u || !pin){ $("staffMsg").textContent="Enter username + PIN."; return; }
      $("staffMsg").textContent="Checking…";

      try{
        BRAND_ID = bid;
        await ensureBrandShell(BRAND_ID);
        await loadBrand(BRAND_ID);

        const { staffCol } = basePaths(BRAND_ID);
        const qs = await getDocs(query(staffCol, where("username","==",u), limit(1)));
        if(qs.empty){ $("staffMsg").textContent="User not found."; return; }
        const docu = qs.docs[0];
        const data = docu.data() || {};
        let ok = false;
        // Dashboard creates staff with pinHash (SHA-256). Support both pinHash and legacy pin.
        if(data.pinHash){
          const enteredHash = await sha256Hex(pin);
          ok = String(data.pinHash) === String(enteredHash);
        }else{
          ok = String(data.pin||"") === String(pin);
        }
        ok = ok && data.active !== false;
        if(!ok){ $("staffMsg").textContent="Invalid PIN or inactive user."; return; }

        ROLE = (data.role || "cashier");
        STAFF = { id: docu.id, username:u, role:ROLE };
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        localStorage.setItem("luma_pos_role", ROLE);
        localStorage.setItem("luma_pos_staff", JSON.stringify(STAFF));

        // Staff login does not require Firebase Auth session.
        setPill("ok", `Ready • ${ROLE}`);
        showApp(true);
        startProductsListener();
        renderCart();
        toast("Welcome", `${u} • ${ROLE}`);
        openDrawer("authDrawer", false);
        document.getElementById("authMsgInline").textContent = `Ready • ${ROLE}`;
        $("staffMsg").textContent="";
      }catch(e){
        console.error(e);
        $("staffMsg").textContent = e?.message || "Staff login failed.";
      }
    };

    // ---------- Session restore ----------
    async function restore(){
      const bid = localStorage.getItem("luma_pos_brandId") || "";
      if(bid) $("brandId").value = bid;
      // Owner session will be restored via Firebase Auth onAuthStateChanged.
      const staff = localStorage.getItem("luma_pos_staff");
      const role = localStorage.getItem("luma_pos_role");
      if(staff && bid && !auth.currentUser){
        try{
          BRAND_ID = bid;
          ROLE = role || "cashier";
          STAFF = JSON.parse(staff);
          await ensureBrandShell(BRAND_ID);
          await loadBrand(BRAND_ID);
          setPill("ok", `Ready • ${ROLE}`);
          showApp(true);
          startProductsListener();
          renderCart();
        }catch(e){ console.error(e); }
      }
    }

    // ---------- onAuthStateChanged (owner) ----------
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        const bid = needBrandId() || (localStorage.getItem("luma_pos_brandId")||"");
        if(!bid){
          setPill("warn","Enter Brand ID");
          showApp(false);
          return;
        }
        BRAND_ID = bid.trim();
        ROLE = "owner";
        STAFF = null;
        localStorage.setItem("luma_pos_brandId", BRAND_ID);
        localStorage.removeItem("luma_pos_staff");
        localStorage.setItem("luma_pos_role", ROLE);

        try{
          await ensureBrandShell(BRAND_ID);
          await loadBrand(BRAND_ID);
          setPill("ok","Ready • owner");
          showApp(true);
          startProductsListener();
          renderCart();
        }catch(e){
          console.error(e);
          setPill("bad","Boot error");
          showApp(false);
          toast("Error","Failed to load brand.");
        }
      }else{
        // Not signed in (could still be staff restored)
        if(!localStorage.getItem("luma_pos_staff")){
          setPill("warn","Not signed in");
          showApp(false);
          BRAND = null;
          ROLE = "owner";
          STAFF = null;
        }
      }
      setBrandHeader();
    });

    // ---------- Pay / create order ----------
    $("payMethods").onclick = (e)=>{
      const el = e.target.closest(".pm");
      if(!el) return;
      PAY_METHOD = el.getAttribute("data-m");
      document.querySelectorAll(".pm").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
    };

    $("btnClearCart").onclick = ()=>{
      CART = [];
      $("discount").value = "";
      $("tax").value = "";
      $("customerName").value = "";
      $("orderNote").value = "";
      $("afterPayHint").textContent = "";
      renderCart();
    };

    $("discount").oninput = recalc;
    $("tax").oninput = recalc;
    $("search").oninput = ()=>{ SEARCH = $("search").value; renderProducts(); };

    $("btnPay").onclick = async ()=>{
      if(!BRAND_ID){ toast("Not ready","Sign in first."); return; }
      if(CART.length===0){ toast("Empty cart","Add items first."); return; }

      const subtotal = CART.reduce((s,l)=> s + (Number(l.price||0)*Number(l.qty||0)), 0);
      const discount = Math.max(0, Number(($("discount").value||"0").replace(",",".")) || 0);
      const tax = Math.max(0, Number(($("tax").value||"0").replace(",",".")) || 0);
      const total = Math.max(0, subtotal - discount + tax);

      const order = {
        brandId: BRAND_ID,
        brandName: BRAND?.name || BRAND_ID,
        brandLogoUrl: BRAND?.logoUrl || "",
        status: "preparing",
        items: CART.map(l=>({
          productId: l.productId,
          name: l.name,
          qty: Number(l.qty||0),
          price: Number(l.price||0),
          note: (l.note||"").trim() || null
        })),
        orderNote: ($("orderNote").value||"").trim() || null,
        customerName: ($("customerName").value||"").trim() || null,
        totals: {
          subtotal: Number(subtotal.toFixed(2)),
          discount: Number(discount.toFixed(2)),
          tax: Number(tax.toFixed(2)),
          total: Number(total.toFixed(2))
        },
        payment: {
          method: PAY_METHOD,
          paidAt: serverTimestamp()
        },
        meta: {
          source: "pos",
          role: ROLE,
          staffUsername: STAFF?.username || null,
          createdAtISO: nowISO()
        },
        timestamps: {
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          completedAt: null,
          cancelledAt: null
        }
      };

      $("btnPay").disabled = true;
      try{
        const { ordersCol, runtimeCustomerDoc } = basePaths(BRAND_ID);
        const ref = await addDoc(ordersCol, order);

        // Customer display pointer (no params customer screen)
        await setDoc(runtimeCustomerDoc, {
          lastPaidOrderId: ref.id,
          lastPaidAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        const receiptUrl = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(ref.id)}`;
        $("afterPayHint").innerHTML = `
          ✅ Order sent. <b>Order ID:</b> <code>${ref.id}</code><br/>
          Receipt link: <code>${escapeHtml(receiptUrl)}</code>
        `;
        toast("Paid & sent to kitchen", `Order ${ref.id}`);

        // Reset cart for next order
        CART = [];
        $("discount").value = "";
        $("tax").value = "";
        $("customerName").value = "";
        $("orderNote").value = "";
        renderCart();
      }catch(e){
        console.error(e);
        toast("Payment failed", e?.message || "Could not create order.");
      }finally{
        $("btnPay").disabled = false;
      }
    };

    // ---------- Products manager ----------
    function openDrawer(id, yes){
      const d = $(id);
      d.style.display = yes ? "flex" : "none";
    }

    // ---------- Auth modal (login) ----------
    function syncAuthModalBrand(){
      const bid = (document.getElementById("brandId").value||"").trim();
      const bc = document.getElementById("brandCode");
      if(bc) bc.textContent = bid || "—";
    }
    document.getElementById("brandId").addEventListener("input", ()=>{
      syncAuthModalBrand();
      document.getElementById("authMsgInline").textContent = "Not signed in";
    });

    document.getElementById("btnOpenAuth").onclick = ()=>{
      syncAuthModalBrand();
      openDrawer("authDrawer", true);
    };
    document.getElementById("btnCloseAuth").onclick = ()=> openDrawer("authDrawer", false);

    document.getElementById("authTabs").onclick = (e)=>{
      const tab = e.target.closest(".chip")?.getAttribute("data-tab");
      if(!tab) return;
      document.querySelectorAll("#authTabs .chip").forEach(x=>x.classList.remove("active"));
      e.target.closest(".chip").classList.add("active");
      document.getElementById("tabOwner").classList.toggle("hidden", tab!=="owner");
      document.getElementById("tabStaff").classList.toggle("hidden", tab!=="staff");
    };
    $("btnOpenProducts").onclick = ()=> openDrawer("productsDrawer", true);
    $("btnCloseProducts").onclick = ()=> openDrawer("productsDrawer", false);
    $("btnOpenRecent").onclick = ()=> { openDrawer("recentDrawer", true); refreshRecent(); };
    $("btnCloseRecent").onclick = ()=> openDrawer("recentDrawer", false);

    $("btnClearP").onclick = ()=>{
      $("pName").value=""; $("pCat").value=""; $("pPrice").value=""; $("pDesc").value=""; $("pImg").value="";
      $("pmMsg").textContent="";
    };

    $("btnSaveP").onclick = async ()=>{
      if(!BRAND_ID){ toast("Not ready","Sign in first."); return; }
      const name = ($("pName").value||"").trim();
      const category = ($("pCat").value||"").trim() || "Uncategorized";
      const price = Number(($("pPrice").value||"0").replace(",",".")) || 0;
      const desc = ($("pDesc").value||"").trim() || "";
      const file = $("pImg").files?.[0] || null;
      if(!name || price<=0){ $("pmMsg").textContent="Enter name + valid price."; return; }

      $("btnSaveP").disabled = true;
      $("pmMsg").textContent = "Saving…";
      try{
        let imageUrl = "";
        if(file){
          const path = `brands/${BRAND_ID}/products/${Date.now()}_${file.name}`;
          const r = sRef(storage, path);
          await uploadBytes(r, file);
          imageUrl = await getDownloadURL(r);
        }
        const { productsCol } = basePaths(BRAND_ID);
        await addDoc(productsCol, {
          name, category, price,
          desc: desc || null,
          imageUrl: imageUrl || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        $("pmMsg").textContent = "✅ Saved";
        toast("Product saved", name);
        $("btnClearP").click();
      }catch(e){
        console.error(e);
        $("pmMsg").textContent = e?.message || "Save failed.";
      }finally{
        $("btnSaveP").disabled = false;
      }
    };

    // Simple list view inside products drawer
    function renderPMList(){
      const root = $("pmList");
      root.innerHTML = "";
      if(PRODUCTS.length===0){
        root.innerHTML = `<div class="empty">No products yet.</div>`;
        return;
      }
      for(const p of PRODUCTS){
        const el = document.createElement("div");
        el.className="line";
        el.innerHTML = `
          <div>
            <div class="title">${escapeHtml(p.name)}</div>
            <div class="sub">${escapeHtml(p.category)} • ${money(p.price)} EGP</div>
          </div>
          <div class="qty"><span class="pill"><span class="dot ok"></span>Active</span></div>
        `;
        root.appendChild(el);
      }
    }
    // keep PM list up to date
    setInterval(()=>{ if($("productsDrawer").style.display==="flex") renderPMList(); }, 900);

    // ---------- Recent orders ----------
    async function refreshRecent(){
      if(!BRAND_ID) return;
      const root = $("recentList");
      root.innerHTML = `<div class="empty">Loading…</div>`;
      try{
        const { ordersCol } = basePaths(BRAND_ID);
        const qs = await getDocs(query(ordersCol, orderBy("timestamps.createdAt","desc"), limit(20)));
        if(qs.empty){ root.innerHTML = `<div class="empty">No orders yet.</div>`; return; }
        root.innerHTML = "";
        for(const d of qs.docs){
          const o = d.data()||{};
          const status = o.status || "preparing";
          const total = o.totals?.total ?? 0;
          const pm = o.payment?.method || "-";
          const id = d.id;

          const card = document.createElement("div");
          card.className = "line";
          card.innerHTML = `
            <div>
              <div class="title">#${escapeHtml(id)}</div>
              <div class="sub">${escapeHtml(status)} • ${money(total)} EGP • ${escapeHtml(pm)}</div>
              <div class="hint" style="margin-top:6px">${escapeHtml((o.items||[]).map(x=>`${x.qty}× ${x.name}`).join(" • ") || "")}</div>
            </div>
            <div class="qty">
              <button class="btn" data-open="${id}">Receipt</button>
              <button class="btn danger" data-cancel="${id}" ${status==="cancelled"?"disabled":""}>Cancel</button>
              <button class="btn" data-refund="${id}">Refund</button>
            </div>
          `;
          root.appendChild(card);
        }

        root.querySelectorAll("button[data-open]").forEach(b=>{
          b.onclick=()=>{
            const id=b.getAttribute("data-open");
            const url = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(id)}`;
            window.open(url, "_blank");
          };
        });
        root.querySelectorAll("button[data-cancel]").forEach(b=>{
          b.onclick=()=> cancelOrder(b.getAttribute("data-cancel"));
        });
        root.querySelectorAll("button[data-refund]").forEach(b=>{
          b.onclick=()=> refundOrder(b.getAttribute("data-refund"));
        });

      }catch(e){
        console.error(e);
        root.innerHTML = `<div class="empty">Failed to load recent orders.</div>`;
      }
    }
    $("btnRefreshRecent").onclick = refreshRecent;

    async function cancelOrder(orderId){
      if(!confirm(`Cancel order ${orderId}?`)) return;
      try{
        const orderRef = doc(db, `brands/${BRAND_ID}/orders/${orderId}`);
        await updateDoc(orderRef, {
          status:"cancelled",
          "timestamps.cancelledAt": serverTimestamp(),
          "timestamps.updatedAt": serverTimestamp()
        });
        toast("Cancelled", orderId);
        refreshRecent();
      }catch(e){
        console.error(e);
        toast("Cancel failed", e?.message || "");
      }
    }

    async function refundOrder(orderId){
      const amountStr = prompt("Refund amount (blank = full):", "");
      if(amountStr === null) return;
      let amount = null;
      if(String(amountStr||"").trim()!==""){
        amount = Math.max(0, Number(String(amountStr).replace(",",".")) || 0);
      }
      try{
        const orderRef = doc(db, `brands/${BRAND_ID}/orders/${orderId}`);
        await updateDoc(orderRef, {
          refund: { amount: amount, at: serverTimestamp() },
          "timestamps.updatedAt": serverTimestamp()
        });
        toast("Refund recorded", `${orderId}${amount!=null?` • ${money(amount)} EGP`:" • full"}`);
        refreshRecent();
      }catch(e){
        console.error(e);
        toast("Refund failed", e?.message || "");
      }
    }

    // ---------- Sign out ----------
    $("btnSignOut").onclick = async ()=>{
      // clear staff
      localStorage.removeItem("luma_pos_staff");
      localStorage.removeItem("luma_pos_role");
      STAFF = null;
      ROLE = "owner";
      BRAND = null;
      PRODUCTS = [];
      CART = [];
      renderCart();
      try{
        if(auth.currentUser) await signOut(auth);
      }catch(e){}
      setPill("warn","Not signed in");
      showApp(false);
      setBrandHeader();
      toast("Signed out","See you.");
      openDrawer("authDrawer", false);
      const inline = document.getElementById("authMsgInline"); if(inline) inline.textContent="Not signed in";
    };

    // ---------- boot ----------
    setPill("warn","Not signed in");
    restore();

    // close drawers by backdrop click
    ["productsDrawer","recentDrawer"].forEach(id=>{
      const el = $(id);
      el.addEventListener("click",(e)=>{ if(e.target===el) openDrawer(id,false); });
    });
  </script>
</body>
</html>
