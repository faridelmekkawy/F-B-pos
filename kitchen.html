<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma — Kitchen (KDS)</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2f;
      --panel2:#0f172a;
      --card:#0b1326;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.10);
      --accent:#60a5fa;
      --accent2:#2563eb;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow:0 18px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,system-ui;background:radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                                      radial-gradient(900px 600px at 120% 10%, rgba(34,197,94,.18), transparent 55%),
                                      var(--bg); color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(16,26,47,.92), rgba(16,26,47,.72));backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border)}
    .hwrap{max-width:1400px;margin:0 auto;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(96,165,250,.25), rgba(255,255,255,.06));
      display:grid;place-items:center;font-weight:900;color:var(--accent);overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:rgba(255,255,255,.06);
      padding:8px 10px;border-radius:999px;font-weight:900;font-size:12px;color:var(--muted)}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--danger)}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--ink);padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent2),var(--accent));border-color:transparent}
    .btn:active{transform:translateY(1px)}
    main{max-width:1400px;margin:12px auto;padding:0 14px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.cols{grid-template-columns:1fr}}
    .col{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border); border-radius:24px; box-shadow:var(--shadow); overflow:hidden;
    }
    .colHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .colHead h2{margin:0;font-size:13px;letter-spacing:.3px}
    .count{font-size:12px;color:var(--muted);font-weight:900}
    .list{padding:12px;display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:1200px){ .list{grid-template-columns:1fr 1fr;} }

    .card{
      position:relative;
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(15,23,42,.88), rgba(11,19,38,.88));
      overflow:hidden;
    }
    .stripe{position:absolute;left:0;top:0;bottom:0;width:10px;background:rgba(245,158,11,.9)}
    .stripe.ok{background:rgba(34,197,94,.9)}
    .stripe.bad{background:rgba(239,68,68,.9)}
    .cBody{padding:12px 12px 12px 16px}
    .cTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .oid{font-weight:1000;font-size:14px;letter-spacing:.3px}
    .meta{font-size:11px;color:var(--muted);font-weight:800;margin-top:4px}
    .age{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--border); background:rgba(255,255,255,.06);
      padding:7px 9px;border-radius:999px;font-weight:1000;font-size:12px
    }
    .age.warn{color:#fde68a}
    .age.bad{color:#fecaca}
    .items{margin-top:10px;border-top:1px dashed rgba(255,255,255,.12);padding-top:10px}
    .it{display:flex;justify-content:space-between;gap:10px;font-size:12px;margin-top:7px}
    .it .name{font-weight:900}
    .it .right{color:var(--muted);font-weight:900}
    .note{margin-top:8px;font-size:11px;color:#e0e7ff;background:rgba(99,102,241,.12);border:1px dashed rgba(99,102,241,.35);
      padding:7px 8px;border-radius:12px}
    .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    footer{text-align:center;color:var(--muted);font-weight:900;font-size:12px;margin:14px 0}
    .empty{color:var(--muted);font-weight:900;padding:10px;border:1px dashed rgba(255,255,255,.14);border-radius:16px;background:rgba(255,255,255,.03)}
  </style>
</head>
<body>
<header>
  <div class="hwrap">
    <div class="brand">
      <div class="logo" id="logoBox"><span id="logoFallback">L</span><img id="logoImg" alt="logo" style="display:none"></div>
      <div>
        <h1 id="brandName">Kitchen (KDS)</h1>
        <div class="sub">Brand: <span id="brandIdLine">—</span></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="pill"><span class="dot warn"></span> Preparing</span>
      <span class="pill"><span class="dot ok"></span> Completed</span>
      <button class="btn" id="btnSetBrand">Set Brand</button>
      <button class="btn primary" id="btnRefresh">Refresh</button>
    </div>
  </div>
</header>

<main>
  <div class="cols">
    <section class="col">
      <div class="colHead">
        <h2>NEW / PREPARING</h2>
        <div class="count"><span id="prepCount">0</span> orders</div>
      </div>
      <div class="list" id="prepList"></div>
    </section>

    <section class="col">
      <div class="colHead">
        <h2>COMPLETED</h2>
        <div class="count"><span id="doneCount">0</span> orders</div>
      </div>
      <div class="list" id="doneList"></div>
    </section>
  </div>
</main>

<footer>Powered by Luma</footer>

<script type="module">
  // ================== Firebase config (PASTE YOUR CREDENTIALS HERE) ==================
  const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  };
  // ================================================================================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const $ = (id)=>document.getElementById(id);

  const LS_KEY = "luma_brandId";

  function getBrandId(){ return (localStorage.getItem(LS_KEY) || "").trim(); }
  function setBrandId(v){ localStorage.setItem(LS_KEY, (v||"").trim()); }

  function money(n){ return Number(n||0).toFixed(2); }

  function getDateFromAny(ts){
    try{
      if(!ts) return null;
      if(ts.toDate) return ts.toDate();
      if(ts.seconds) return new Date(ts.seconds*1000);
      return new Date(ts);
    }catch(e){ return null; }
  }

  function minsAgo(d){
    if(!d) return null;
    const ms = Date.now() - d.getTime();
    return Math.max(0, Math.floor(ms/60000));
  }

  function ageClass(mins){
    // You said ready/completed are same. We'll just pressure-color preparing.
    // 0-9: normal, 10-19: warn, 20+: bad
    if(mins >= 20) return "bad";
    if(mins >= 10) return "warn";
    return "";
  }

  function renderCard(o, id, isDone){
    const created = getDateFromAny(o.createdAt || o.timestamps?.createdAt);
    const m = minsAgo(created);
    const cls = ageClass(m||0);

    const card = document.createElement("div");
    card.className = "card";

    const stripe = document.createElement("div");
    stripe.className = "stripe " + (isDone ? "ok" : (cls || ""));
    card.appendChild(stripe);

    const body = document.createElement("div");
    body.className = "cBody";
    body.innerHTML = `
      <div class="cTop">
        <div>
          <div class="oid">#${o.orderNo || id.slice(-6).toUpperCase()}</div>
          <div class="meta">${created ? created.toLocaleString() : "—"}</div>
        </div>
        <div class="age ${cls ? cls : ""}">${isDone ? "Done" : ((m==null) ? "—" : (m + " mins"))}</div>
      </div>
      <div class="items"></div>
      ${o.orderNote ? `<div class="note"><b>Kitchen note:</b> ${escapeHtml(o.orderNote)}</div>` : ""}
      <div class="actions"></div>
    `;

    const itemsEl = body.querySelector(".items");
    const items = Array.isArray(o.items) ? o.items : [];
    if(items.length === 0){
      const it = document.createElement("div");
      it.className = "it";
      it.innerHTML = `<div class="name">No items</div><div class="right">—</div>`;
      itemsEl.appendChild(it);
    }else{
      items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "it";
        const left = `<div class="name">${escapeHtml(String(it.qty||1))}× ${escapeHtml(it.name||"Item")}${it.note?` <span style="color:#c7d2fe;font-weight:900">(${escapeHtml(it.note)})</span>`:""}</div>`;
        const right = `<div class="right">${money((Number(it.qty||1)*Number(it.price||0)))}</div>`;
        row.innerHTML = left + right;
        itemsEl.appendChild(row);
      });
    }

    const actions = body.querySelector(".actions");
    if(!isDone){
      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.textContent = "Mark Completed";
      btn.onclick = async ()=>{
        const brandId = getBrandId();
        await updateDoc(doc(db, `brands/${brandId}/orders/${id}`),{
          status:"completed",
          "timestamps.completedAt": serverTimestamp(),
          "timestamps.updatedAt": serverTimestamp(),
          // Keep legacy fields if your other screens use them
          completedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      };
      actions.appendChild(btn);

      const small = document.createElement("span");
      small.className = "pill";
      small.innerHTML = `<span class="dot ${cls==='bad'?'bad':(cls==='warn'?'warn':'warn')}"></span>${escapeHtml(o.status||"preparing")}`;
      actions.appendChild(small);
    }else{
      const small = document.createElement("span");
      small.className = "pill";
      small.innerHTML = `<span class="dot ok"></span>completed`;
      actions.appendChild(small);
    }

    card.appendChild(body);
    return card;
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  let unsubPrep=null, unsubDone=null;

  function cleanup(){
    try{unsubPrep && unsubPrep();}catch(e){}
    try{unsubDone && unsubDone();}catch(e){}
    unsubPrep = unsubDone = null;
  }

  function setHeaderBrand(brandId){
    $("brandIdLine").textContent = brandId || "—";
    $("brandName").textContent = "Kitchen (KDS)";
    $("logoFallback").textContent = (brandId || "L").slice(0,1).toUpperCase();
  }

  function subscribe(){
    cleanup();
    const brandId = getBrandId();
    setHeaderBrand(brandId);

    if(!brandId){
      $("prepList").innerHTML = `<div class="empty">No brand set. Tap <b>Set Brand</b> and enter your brandId.</div>`;
      $("doneList").innerHTML = `<div class="empty">Waiting…</div>`;
      $("prepCount").textContent = "0";
      $("doneCount").textContent = "0";
      return;
    }

    // Preparing
    const qPrep = query(
      collection(db, `brands/${brandId}/orders`),
      where("status","==","preparing"),
      orderBy("timestamps.createdAt","asc"),
      limit(200)
    );
    unsubPrep = onSnapshot(qPrep, snap=>{
      $("prepCount").textContent = String(snap.size||0);
      const el = $("prepList");
      el.innerHTML = "";
      if(!snap.size){
        el.innerHTML = `<div class="empty">No preparing orders right now.</div>`;
        return;
      }
      snap.forEach(s => el.appendChild(renderCard(s.data(), s.id, false)));
    });

    // Completed (recent)
    const qDone = query(
      collection(db, `brands/${brandId}/orders`),
      where("status","==","completed"),
      orderBy("timestamps.completedAt","desc"),
      limit(200)
    );
    unsubDone = onSnapshot(qDone, snap=>{
      $("doneCount").textContent = String(snap.size||0);
      const el = $("doneList");
      el.innerHTML = "";
      if(!snap.size){
        el.innerHTML = `<div class="empty">No completed orders yet.</div>`;
        return;
      }
      snap.forEach(s => el.appendChild(renderCard(s.data(), s.id, true)));
    });
  }

  // live age refresh (so mins update without reloading)
  setInterval(()=>{
    // just force re-render by resubscribing? too heavy. We'll only update the badges.
    document.querySelectorAll(".card").forEach(card=>{
      const meta = card.querySelector(".meta");
      // no-op: we keep it simple; Firestore snapshots will refresh often enough in practice.
    });
  }, 30000);

  $("btnSetBrand").onclick = ()=>{
    const v = prompt("Enter brandId (same one you use in POS):", getBrandId());
    if(v){ setBrandId(v); subscribe(); }
  };
  $("btnRefresh").onclick = ()=> subscribe();

  subscribe();
</script>
</body>
</html>
