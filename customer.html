<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma ‚Äî Customer Display</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.12);
      --ink:#ffffff;
      --muted:rgba(255,255,255,.75);
      --border:rgba(255,255,255,.14);
      --accent:#60a5fa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --radius:18px;
      --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(1200px 800px at 80% 80%, rgba(34,197,94,.14), transparent 55%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
      gap:12px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--border);
      display:grid;place-items:center;
      overflow:hidden;flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{
      margin:0;
      font-size:17px;
      line-height:1.1;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 46vw;
    }
    .sub{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 54vw;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      font-weight:900;
      letter-spacing:.2px;
      font-size:13px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--danger)}

    .pairBox{
      max-width:560px;
      margin:18px auto 0;
      padding:16px;
      border-radius:18px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.07);
      box-shadow:var(--shadow);
    }
    .pairBox h2{margin:0 0 8px;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;margin-top:10px}
    input{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--ink);
      font-weight:800;
      outline:none;
    }
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.12)}

    main{
      flex:1;
      padding:14px 16px 14px;
    }

    /* Layout: board + details */
    .layout{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      min-height: calc(100vh - 72px - 44px);
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }
#qrcode{
  width:260px;
  height:260px;
  background:#fff;
  padding:14px;
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 18px 50px rgba(0,0,0,.25);
}
#qrcode canvas, #qrcode img{
  width:100% !important;
  height:100% !important;
  border-radius:14px;
}

    /* Board-only idle mode */
    body.boardOnly .layout{grid-template-columns:1fr}
    body.boardOnly .details{display:none}

    .card{
      background:linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(255,255,255,.04);
    }
    .hd b{font-size:14px}
    .bd{padding:12px 14px}

    /* Board look (like the photo) */
    .boardTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .boardTitle{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:14px;
    }
    .boardHint{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .boardGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .col{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      overflow:hidden;
      min-height: 520px;
      display:flex;
      flex-direction:column;
    }
    .colHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-weight:1000;
      letter-spacing:.2px;
      font-size:13px;
      background:rgba(255,255,255,.05);
    }
    .colHeader.prep{background:rgba(245,158,11,.18)}
    .colHeader.ready{background:rgba(34,197,94,.18)}
    .countChip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      font-weight:900;
    }
    .numbers{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      flex:1;
      align-content:start;
    }
    .num{
      text-align:center;
      padding:10px 8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.16);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight:1000;
      font-size:26px;
      letter-spacing:.6px;
    }
    .empty{
      padding:14px;
      color:rgba(255,255,255,.7);
      font-weight:800;
      text-align:center;
    }

    /* Details */
    .bigTotal{
      font-size:44px;
      font-weight:1000;
      letter-spacing:.4px;
      margin:10px 0 6px;
    }
    .grid2{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
      margin-top:10px;
    }
    .kv{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      display:flex;justify-content:space-between;gap:10px;
      font-weight:900;
    }
    .kv span{color:var(--muted);font-weight:800}
    .items{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      display:flex;justify-content:space-between;gap:10px;
    }
    .item .l{min-width:0}
    .item .name{
      font-weight:1000;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width: 44vw;
    }
    .item .meta{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .item .r{text-align:right;font-weight:1000;flex:0 0 auto}
    .note{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.24);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.85);
      font-weight:800;
    }

    .qrWrap{
      display:grid;
      place-items:center;
      padding:12px;
      gap:10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(255,255,255,.06);
      margin-top:12px;
    }
    #qrcode{
      width:220px;height:220px;
      background:#fff;
      padding:12px;
      border-radius:18px;
    }
    .qrHint{text-align:center;font-weight:1000;color:rgba(255,255,255,.92);line-height:1.3}

    footer{
      padding:12px 18px;
      border-top:1px solid var(--border);
      color:rgba(255,255,255,.70);
      font-weight:900;
      text-align:center;
      background:rgba(255,255,255,.03);
    }
  </style>

  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>

<body>
  <header>
    <div class="brand">
      <div class="logo" id="logoBox"><span style="font-weight:900;color:rgba(255,255,255,.7)">üçî</span></div>
      <div style="min-width:0">
        <h1 id="brandName">Customer Display</h1>
        <div class="sub" id="subLine">Waiting for the next paid order‚Ä¶</div>
      </div>
    </div>
    <div class="pill"><span class="dot" id="dot"></span><span id="statusTxt">Idle</span></div>
  </header>

  <div id="pairing" class="pairBox" style="display:none">
    <h2>Pair this screen</h2>
    <div class="muted">Enter your <b>Brand ID</b> once. Then this screen shows the live order board + latest paid order.</div>
    <div class="row">
      <input id="brandIdInput" placeholder="Brand ID (e.g. B001)" autocomplete="off"/>
      <button class="btn" id="pairBtn">Pair</button>
    </div>
    <div class="muted" style="margin-top:10px;font-size:12px">Tip: refresh or reset anytime if you move this tablet.</div>
  </div>

  <main id="mainUI" style="display:none">
    <div class="layout">
      <!-- Board -->
      <section class="card board">
        <div class="hd">
          <b>Order Board</b>
          <span class="muted" id="boardMeta">‚Äî</span>
        </div>
        <div class="bd">
          <div class="boardTop">
            <div class="boardTitle">Live Orders</div>
            <div class="boardHint" id="boardHint">Preparing ‚Üí Completed</div>
          </div>

          <div class="boardGrid">
            <div class="col">
              <div class="colHeader prep">
                <span>Preparing‚Ä¶</span>
                <span class="countChip" id="prepCount">0</span>
              </div>
              <div class="numbers" id="prepNums"></div>
              <div class="empty" id="prepEmpty" style="display:none">No orders preparing.</div>
            </div>

            <div class="col">
              <div class="colHeader ready">
                <span>Please Collect</span>
                <span class="countChip" id="readyCount">0</span>
              </div>
              <div class="numbers" id="readyNums"></div>
              <div class="empty" id="readyEmpty" style="display:none">
                No ready orders (we hide ready orders older than 15 minutes).
              </div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px;font-weight:800">
            Note: ‚ÄúPlease Collect‚Äù hides orders that were completed more than <b>15 minutes</b> ago.
          </div>
        </div>
      </section>

      <!-- Details -->
      <aside class="card details" id="detailsCard">
        <div class="hd">
          <b>Latest Paid Order</b>
          <span class="muted" id="orderMeta">‚Äî</span>
        </div>
        <div class="bd">
          <div class="bigTotal" id="grandTotal">‚Äî</div>

          <div class="grid2">
            <div class="kv"><span>Subtotal</span><b id="subTotal">‚Äî</b></div>
            <div class="kv"><span>Tax</span><b id="tax">‚Äî</b></div>
            <div class="kv"><span>Discount</span><b id="discount">‚Äî</b></div>
            <div class="kv"><span>Payment</span><b id="payment">‚Äî</b></div>
          </div>

          <div class="items" id="items"></div>

          <div class="note" id="orderNote" style="display:none"></div>

          <div class="qrWrap">
            <div id="qrcode"></div>
            <div class="qrHint" id="qrHint">Scan to view your receipt</div>
            <button class="btn" id="resetBtn" style="width:100%">Reset Screen</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer>Powered by Luma</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore,
      doc, getDoc,
      collection, query, orderBy, limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // =========================
    // Firebase config (paste yours)
    // =========================
    const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const money = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"EGP", maximumFractionDigits:2 });
    };

    const tsToDate = (t) => {
      if(!t) return null;
      if (typeof t.toDate === "function") return t.toDate();
      if (t.seconds) return new Date(t.seconds * 1000);
      return null;
    };

    const escapeHtml = (s) => String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    function setStatus(status){
      const dot = $("dot");
      const txt = $("statusTxt");
      txt.textContent = status || "Idle";
      dot.classList.remove("ok","bad");
      if(status === "completed") dot.classList.add("ok");
      else if(status === "cancelled") dot.classList.add("bad");
    }

    function setBrandHeader({name, logoUrl}){
      $("brandName").textContent = name || "Customer Display";
      const box = $("logoBox");
      if(logoUrl){
        box.innerHTML = `<img alt="logo" src="${logoUrl}">`;
      }else{
        box.innerHTML = `<span style="font-weight:900;color:rgba(255,255,255,.7)">üçî</span>`;
      }
    }

    // =========================
    // Idle behavior: if no NEW order in 2 mins ‚Üí board full screen
    // =========================
    const IDLE_MS = 2 * 60 * 1000;
    let idleTimer = null;

    function enterBoardOnlyMode(){ document.body.classList.add("boardOnly"); }
    function exitBoardOnlyMode(){ document.body.classList.remove("boardOnly"); }

    function resetIdleTimer(){
      if(idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(() => enterBoardOnlyMode(), IDLE_MS);
    }

    // =========================
    // Pairing (no URL params)
    // =========================
    const LS_KEY = "luma_brandId_customerScreen";
    let brandId = localStorage.getItem(LS_KEY) || "";

    $("pairBtn").onclick = () => {
      const v = ($("brandIdInput").value || "").trim();
      if(!v) return;
      brandId = v;
      localStorage.setItem(LS_KEY, brandId);
      boot();
    };

    $("resetBtn").onclick = () => {
      localStorage.removeItem(LS_KEY);
      location.reload();
    };

    function showPairing(){
      $("pairing").style.display = "block";
      $("mainUI").style.display = "none";
      $("subLine").textContent = "Pair this screen to a brand.";
      setStatus("Idle");
    }
    function showUI(){
      $("pairing").style.display = "none";
      $("mainUI").style.display = "block";
    }

    // =========================
    // Firestore listeners
    // =========================
    let unsubRuntime = null;
    let unsubOrder = null;
    let unsubBoard = null;
    let lastOrderId = null;

    function clearOrderUI(){
      $("orderMeta").textContent = "‚Äî";
      $("grandTotal").textContent = "‚Äî";
      $("subTotal").textContent = "‚Äî";
      $("tax").textContent = "‚Äî";
      $("discount").textContent = "‚Äî";
      $("payment").textContent = "‚Äî";
      $("items").innerHTML = "";
      $("orderNote").style.display = "none";
      $("qrcode").innerHTML = "";
      $("qrHint").textContent = "Scan to view your receipt";
    }

    function renderNums(elNums, elEmpty, list){
      elNums.innerHTML = "";
      if(!list.length){
        elEmpty.style.display = "block";
        return;
      }
      elEmpty.style.display = "none";
      for(const n of list){
        const d = document.createElement("div");
        d.className = "num";
        d.textContent = n;
        elNums.appendChild(d);
      }
    }

    async function boot(){
      if(unsubRuntime) unsubRuntime();
      if(unsubOrder) unsubOrder();
      if(unsubBoard) unsubBoard();
      unsubRuntime = unsubOrder = unsubBoard = null;
      lastOrderId = null;

      if(!brandId){
        showPairing();
        return;
      }

      showUI();
      exitBoardOnlyMode(); // start in split mode; if idle, it will switch automatically

      // Brand header from brand doc (fallback; order will override if it has brandName/logo)
      try{
        const bSnap = await getDoc(doc(db, `brands/${brandId}`));
        if(bSnap.exists()){
          const b = bSnap.data();
          setBrandHeader({
            name: b.name || b.brandName || `Brand ${brandId}`,
            logoUrl: b.logoUrl || b.brandLogoUrl || ""
          });
        }else{
          setBrandHeader({ name: `Brand ${brandId}`, logoUrl: "" });
        }
      }catch{
        setBrandHeader({ name: `Brand ${brandId}`, logoUrl: "" });
      }

      $("subLine").textContent = "Waiting for the next paid order‚Ä¶";
      setStatus("Idle");
      clearOrderUI();

      // ===== Board listener =====
      const ordersRef = collection(db, `brands/${brandId}/orders`);
const boardQuery = query(ordersRef, orderBy("timestamps.createdAt", "desc"), limit(120));

      unsubBoard = onSnapshot(boardQuery, (snap) => {
        const now = Date.now();
        const READY_HIDE_OLDER_THAN_MIN = 15; // hide ready orders older than 15 minutes
        const readyMaxAgeMs = READY_HIDE_OLDER_THAN_MIN * 60 * 1000;

        const preparing = [];
        const ready = [];

        let newestTs = 0;

        snap.forEach((ds) => {
          const o = ds.data() || {};
          const n = String(o.orderNumber || o.orderNo || o.shortId || ds.id.slice(-3)).toUpperCase();

const created = tsToDate(o.timestamps?.createdAt) || tsToDate(o.timestamps?.updatedAt);
          if(created) newestTs = Math.max(newestTs, created.getTime());

          if(o.status === "preparing"){
            preparing.push(n);
          } else if(o.status === "completed"){
            // hide ready orders older than 15 minutes
const comp = tsToDate(o.timestamps?.completedAt) || tsToDate(o.timestamps?.updatedAt) || created;
            const age = comp ? (now - comp.getTime()) : 0;
            if(age <= readyMaxAgeMs){
              ready.push(n);
            }
          }
        });

        $("prepCount").textContent = preparing.length;
        $("readyCount").textContent = ready.length;

        renderNums($("prepNums"), $("prepEmpty"), preparing.slice(0, 30));
        renderNums($("readyNums"), $("readyEmpty"), ready.slice(0, 30));

        if(newestTs){
          const dt = new Date(newestTs);
          $("boardMeta").textContent = `Updated ${dt.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}`;
        } else {
          $("boardMeta").textContent = "‚Äî";
        }
      });

      // ===== Runtime pointer listener (latest paid order) =====
      const runtimeRef = doc(db, `brands/${brandId}/runtime/customerDisplay`);
      unsubRuntime = onSnapshot(runtimeRef, async (snap) => {
        const d = snap.exists() ? snap.data() : {};
        const oid = d.lastPaidOrderId || d.currentOrderId || d.orderId || null;

        if(!oid){
          $("subLine").textContent = "No paid orders yet.";
          setStatus("Idle");
          clearOrderUI();
          enterBoardOnlyMode(); // show board full screen if no order yet
          return;
        }

        // new order detected
        if(oid !== lastOrderId){
          lastOrderId = oid;

          // show split screen + reset 2 min idle timer
          exitBoardOnlyMode();
          resetIdleTimer();
        }

        if(unsubOrder) unsubOrder();

        const orderRef = doc(db, `brands/${brandId}/orders/${oid}`);
        unsubOrder = onSnapshot(orderRef, async (os) => {
          if(!os.exists()){
            $("subLine").textContent = "Order not found.";
            setStatus("Idle");
            return;
          }
          const o = os.data() || {};
          const status = o.status || "preparing";
          setStatus(status);

          // prefer stable brand fields copied into order
          const bName = o.brandName || o.brand?.name || $("brandName").textContent;
          const bLogo = o.brandLogoUrl || o.brand?.logoUrl || "";
          if(bName || bLogo) setBrandHeader({ name: bName, logoUrl: bLogo });

          const created = tsToDate(o.createdAt) || tsToDate(o.timestamps?.createdAt);
          const when = created ? created.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "‚Äî";
          const orderNo = o.orderNumber || o.orderNo || o.shortId || oid.slice(-6);

          $("orderMeta").textContent = `Order #${orderNo} ‚Ä¢ ${when}`;

          $("subLine").textContent =
            status === "completed" ? "Your order is completed ‚úÖ"
            : status === "cancelled" ? "This order was cancelled."
            : "Your order is being prepared‚Ä¶";

          // totals
          const totals = o.totals || {};
          $("grandTotal").textContent = money(totals.total ?? o.total ?? 0);
          $("subTotal").textContent  = money(totals.subtotal ?? o.subtotal ?? 0);
          $("tax").textContent       = money(totals.tax ?? o.tax ?? 0);
          $("discount").textContent  = money(totals.discount ?? o.discount ?? 0);

          const method = o.payment?.method || o.paymentMethod || "‚Äî";
          $("payment").textContent = String(method).toUpperCase();

          // items
          const items = Array.isArray(o.items) ? o.items : [];
          $("items").innerHTML = items.map(it => {
            const nm = it.name || "Item";
            const qty = Number(it.qty || 1);
            const price = Number(it.price || 0);
            const line = qty * price;
            const note = (it.note || "").trim();
            return `
              <div class="item">
                <div class="l">
                  <div class="name">${escapeHtml(nm)}</div>
                  <div class="meta">
                    <span>Qty: ${qty}</span>
                    <span>${money(price)} each</span>
                    ${note ? `<span>‚Ä¢ Note: ${escapeHtml(note)}</span>` : ``}
                  </div>
                </div>
                <div class="r">${money(line)}</div>
              </div>
            `;
          }).join("");

          // order note
          const onote = (o.orderNote || o.kitchenNote || "").trim();
          if(onote){
            $("orderNote").style.display = "block";
            $("orderNote").textContent = `Kitchen note: ${onote}`;
          }else{
            $("orderNote").style.display = "none";
          }

          // QR must appear once paid (your POS sets status=preparing on payment)
          const receiptUrl = `${location.origin}${location.pathname.replace(/customer\.html$/,'') }receipt.html?brandId=${encodeURIComponent(brandId)}&orderId=${encodeURIComponent(oid)}`;

          $("qrcode").innerHTML = "";
          new QRCode($("qrcode"), {
            text: receiptUrl,
            width: 220,
            height: 220,
            correctLevel: QRCode.CorrectLevel.M
          });

          $("qrHint").textContent = "Scan to view your receipt";
        });
      });
    }

    // start
    if(!brandId) showPairing();
    else boot();
  </script>
</body>
</html>
