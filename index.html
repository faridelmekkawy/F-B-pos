<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Luma — Vendor Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel-soft:#f9fafb;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --accent-strong:#1d4ed8;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --danger:#ef4444;
      --ok:#16a34a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    .hidden{display:none!important;}

/* AUTH WRAPPER */
    .auth-wrapper{
      width:100%;
      max-width:460px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(148,163,184,.3);
      padding:18px;
      margin:40px auto;
    }
    .auth-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .auth-logo{
      width:38px;height:38px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .auth-title{font-size:17px;font-weight:700;}
    .auth-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}

    .auth-tabs{
      display:flex;gap:6px;margin:10px 0 12px;
    }
    .auth-tab{
      flex:1;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel-soft);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      text-align:center;
    }
    .auth-tab.active{
      background:var(--accent-soft);
      border-color:var(--accent-soft);
      color:var(--accent-strong);
      font-weight:600;
    }
    .auth-alert{
      padding:8px 10px;
      border-radius:10px;
      font-size:11px;
      margin-bottom:10px;
    }
    .auth-alert-error{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;}
    .auth-alert-info{background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}

    .field{margin-bottom:10px;}
    .field-label{font-size:11px;margin-bottom:4px;color:#4b5563;}
    .field-input,.field-select,textarea.field-input{
      width:100%;padding:8px;border-radius:9px;
      border:1px solid var(--border);background:#f9fafb;font-size:12px;
    }
    .field-input:focus,.field-select:focus,textarea.field-input:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);
    }
    .field-hint{font-size:10px;color:var(--muted);margin-top:3px;}

    .btn{
      border:none;border-radius:999px;
      padding:8px 12px;font-size:12px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;justify-content:center;
      gap:6px;
    }
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-primary:hover{background:var(--accent-strong);}
    .btn-ghost{
      background:transparent;color:var(--accent-strong);
      border:1px solid var(--accent-soft);
    }
    .btn-ghost:hover{background:var(--accent-soft);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#b91c1c;}

    .auth-footer{text-align:center;margin-top:8px;font-size:10px;color:var(--muted);}
.fileRow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.pillInput{display:flex;gap:6px;align-items:center;background:var(--panel-soft);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
@media print{
  body *{visibility:hidden!important;}
  .print-area, .print-area *{visibility:visible!important;}
  .print-area{position:absolute;left:0;top:0;width:100%;}
  /* avoid clipping */
  canvas{max-width:100%!important;}
}


/* utility */
.hidden{display:none!important;}
.muted{color:var(--muted)!important;}
.hr{height:1px;background:var(--border);margin:12px 0;}
.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
.mini{font-size:11px;color:var(--muted);}

/* sections / headers */
.hd{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.hd h2{font-size:16px;font-weight:800;margin:0;}
.bd{margin-top:6px;}

/* badges */
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
  border:1px solid var(--border);
  background:var(--panel-soft);
  color:var(--ink);
}
.badge.b-ok{background:#dcfce7;border-color:#bbf7d0;color:#166534;}
.badge.b-warn{background:#fef9c3;border-color:#fde68a;color:#854d0e;}
.badge.b-bad{background:#fee2e2;border-color:#fecaca;color:#991b1b;}

/* notices */
.notice{
  background:var(--panel-soft);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
  font-size:12px;
  color:var(--ink);
}
.notice.dangerText{background:#fef2f2;border-color:#fecaca;color:#991b1b;}
.dangerText{color:#991b1b;font-weight:700;}

/* layout rows / grids */
.row{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}
.row .field{flex:1;min-width:180px;}

.split{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
@media(max-width:1000px){
  .split{grid-template-columns:1fr;}
}

/* KPI grid + cards */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}
.kpi{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  box-shadow:var(--shadow);
}
.kpi .t{font-size:12px;color:var(--muted);font-weight:600;}
.kpi .v{font-size:22px;font-weight:800;margin-top:4px;line-height:1.1;}
.kpi .s{font-size:11px;color:var(--muted);margin-top:6px;}

/* buttons – match your tokens */
.btn{
  border:none;
  border-radius:999px;
  padding:8px 12px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  background:var(--panel-soft);
  border:1px solid var(--border);
}
.btn:hover{filter:brightness(.98);}
.btn.primary{background:var(--accent);border-color:transparent;color:#fff;}
.btn.primary:hover{background:var(--accent-strong);}
.btn.ghost{background:transparent;border-color:var(--accent-soft);color:var(--accent-strong);}
.btn.ghost:hover{background:var(--accent-soft);}
.btn.danger,.btn.btn-danger{background:#ef4444;border-color:transparent;color:#fff;}
.btn.danger:hover,.btn.btn-danger:hover{background:#b91c1c;}

/* inputs */
select,input[type="date"],input[type="text"],input[type="number"],input[type="email"],input[type="password"]{
  padding:7px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  font-size:12px;
}
select:focus,input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 2px var(--accent-soft);
}

/* tables inside cards */
table{width:100%;border-collapse:collapse;font-size:12px;}
thead{background:var(--panel-soft);}
th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
th{font-size:11px;text-transform:uppercase;color:var(--muted);letter-spacing:.04em;}
tbody tr:hover{background:#f9fafb;}

/* make charts containers breathe */
canvas{max-width:100%;}

    /* APP LAYOUT */
    .app-shell{
      display:none;
      height:100vh;width:100%;
    }
    .sidebar{
      width:220px;background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      padding:20px 12px;
    }
    .sidebar-brand{
      display:flex;align-items:center;gap:10px;margin-bottom:18px;
    }
    .sidebar-logo{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#2563eb,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;
      overflow:hidden;
      background-size:cover;
      background-position:center;
    }
    .sidebar-brand-name{font-size:15px;font-weight:700;}
    .sidebar-nav{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;flex:1;
    }
    .nav-item{
      padding:9px 12px;border-radius:10px;
      cursor:pointer;font-size:13px;
      border:none;background:transparent;text-align:left;color:var(--ink);
    }
    .nav-item:hover{background:var(--panel-soft);}
    .nav-item.active{background:var(--accent-soft);color:var(--accent-strong);font-weight:600;}
    .nav-item.logout{
      margin-top:auto;
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }
    .nav-item.logout:hover{background:#fecaca;}

    .topbar{
      height:70px;background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:12px 18px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .topbar-title{font-size:16px;font-weight:700;}
    .topbar-sub{font-size:11px;color:var(--muted);}
    .topbar-branch-filter{display:flex;align-items:center;gap:10px;font-size:12px;}
    .topbar-branch-filter select{
      padding:6px 9px;border-radius:8px;
      border:1px solid var(--border);background:var(--panel-soft);
    }

    .content-area{flex:1;padding:20px;overflow-y:auto;background:var(--bg);}
    .page{display:none;}
    .page.active{display:block;}
    .page-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;
    }
    .page-title{font-size:18px;font-weight:700;}
    .page-sub{font-size:12px;color:var(--muted);}
    .page-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .toolbar{
      display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center;
      font-size:12px;
    }
    .toolbar input{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }
    .toolbar select{
      padding:6px 9px;border-radius:9px;
      border:1px solid var(--border);background:#fff;font-size:12px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin-bottom:22px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .card-title{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .card-number{font-size:20px;font-weight:700;}
    .card-note{font-size:11px;color:var(--muted);margin-top:6px;}

    .table-wrapper{
      background:#fff;border-radius:12px;border:1px solid var(--border);
      overflow-x:auto;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead{background:var(--panel-soft);}
    th,td{padding:9px 10px;border-bottom:1px solid var(--border);text-align:left;}
    th{
      font-size:11px;text-transform:uppercase;color:var(--muted);
      letter-spacing:.04em;
    }
    tbody tr:hover{background:#f9fafb;}
    .table-empty{text-align:center;padding:20px;font-size:12px;color:var(--muted);}

    .settings-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;margin-top:14px;
    }
    .settings-card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid var(--border);
      padding:16px;
    }
    .settings-title{font-size:14px;font-weight:600;margin-bottom:12px;}
    .low-stock{
      color:#b91c1c;
      font-weight:600;
    }
    .low-stock-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:11px;
      font-weight:600;
      margin-left:4px;
    }
    #lowStockPanel{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:#fef2f2;
      border:1px solid #fee2e2;
      display:none;
      font-size:12px;
    }
    #lowStockPanelTitle{
      font-weight:600;
      color:#b91c1c;
      margin-bottom:4px;
    }
    #lowStockList{
      color:#7f1d1d;
      font-size:12px;
    }

    /* MODAL */
    #modal-container{
      position:fixed;inset:0;
      display:none;justify-content:center;align-items:center;
      background:rgba(0,0,0,.35);z-index:9999;
    }
    .modal{
      background:var(--panel);
      width:100%;max-width:480px;
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
      animation:fadeIn .2s ease;
    }
    .modal-title{font-size:16px;font-weight:700;margin-bottom:14px;}
    .modal-actions{margin-top:16px;display:flex;justify-content:flex-end;gap:8px;}

    .variant-row{
      display:flex;gap:8px;margin-bottom:6px;
    }
    .variant-row input{flex:1;}
    .variant-row .variant-qty{max-width:80px;}

    @keyframes fadeIn{
      from{transform:scale(.96);opacity:0;}
      to{transform:scale(1);opacity:1;}
    }

    @media(max-width:768px){
      .app-shell{flex-direction:column;}
      .sidebar{width:100%;flex-direction:row;overflow-x:auto;height:auto;}
      .sidebar-nav{flex-direction:row;}
      .topbar{flex-direction:column;align-items:flex-start;gap:8px;height:auto;}
    }
  

/* --- Vendor dashboard: enforce Brand Dashboard look --- */
body{background:var(--bg)!important;}
/* Hide original tab bar from vendor app (we use sidebar) */
.tabs{display:none!important;}
.top{display:none!important;}
/* make vendor app fill main */
#vendor-app-root{width:100%;}
/* ensure footer matches */
.footer{margin:24px 0 8px;color:var(--muted);text-align:center;font-weight:600;}
/* ===== INPUT NORMALIZER (fix weird textbox look) ===== */
.field-input, .field-select, textarea.field-input,
input[type="text"], input[type="number"], input[type="email"],
input[type="password"], input[type="date"], select, textarea{
  height: 38px;
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 12px;
  line-height: 1.2;
  color: var(--ink);
  box-shadow: none;
}

/* textarea should grow, not forced to 38px */
textarea.field-input, textarea{
  height: auto;
  min-height: 90px;
  resize: vertical;
}

/* consistent focus */
.field-input:focus, .field-select:focus,
input:focus, select:focus, textarea:focus{
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-soft);
}

/* remove browser weird inner glow on some inputs */
input, select, textarea{
  -webkit-appearance: none;
  appearance: none;
}
/* SAFETY: make all text inputs look like field-input */
input:not([type="checkbox"]):not([type="radio"]):not([type="file"]),
select,
textarea {
  width: 100%;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 12px;
  font-family: inherit;
}

input:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-soft);
}

</style>
</head>

<body>
<div id="authCard" class="auth-wrapper">
    <div class="auth-header">
      <div class="auth-logo">B</div>
      <div>
        <div class="auth-title">Luma Store OS — Brand Portal</div>
        <div id="auth-subtitle" class="auth-subtitle">Sign in or create your brand</div>
        <div id="authPill" class="auth-subtitle" style="margin-top:6px;">Not signed in</div>
      </div>
    </div>

    <div id="auth-alert-container"></div>

    <div class="field">
      <div class="field-label">Brand ID</div>
      <input id="brandId" class="field-input" placeholder="e.g. oudies" />
      <div class="field-hint">This becomes your Firestore path: <code>brands/{brandId}</code></div>
    </div>

    <div class="auth-tabs">
      <button type="button" id="tab-login" class="auth-tab active">Sign in</button>
      <button type="button" id="tab-create" class="auth-tab">Create brand</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="field">
        <div class="field-label">Email</div>
        <input id="login-email" class="field-input" type="email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="login-password" class="field-input" type="password" placeholder="Your password"/>
      </div>
      <button type="submit" id="login-btn" class="btn btn-primary" style="width:100%;">Sign in</button>
    </form>

    <!-- CREATE BRAND -->
    <form id="create-form" style="display:none;">
      <div class="field">
        <div class="field-label">Brand name</div>
        <input id="brand-name" class="field-input" placeholder="Example: Luma Coffee"/>
      </div>
      <div class="field">
        <div class="field-label">Country (optional)</div>
        <input id="brand-country" class="field-input" placeholder="Egypt, UAE, Germany…"/>
      </div>
      <div class="field">
        <div class="field-label">Your full name</div>
        <input id="owner-name" class="field-input" placeholder="Owner / manager name"/>
      </div>
      <div class="field">
        <div class="field-label">Email</div>
        <input id="owner-email" class="field-input" type="email" placeholder="owner@example.com"/>
      </div>
      <div class="field">
        <div class="field-label">Password</div>
        <input id="owner-password" class="field-input" type="password" placeholder="Minimum 6 characters"/>
      </div>
      <button type="submit" id="create-btn" class="btn btn-primary" style="width:100%;">Create brand</button>
    </form>

    <div class="auth-footer">
      After login, you will access your full dashboard.
    </div>
  </div>

  <div id="app-view" class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div id="sidebar-brand-logo" class="sidebar-logo">
          <img id="dashLogoImg" alt="Logo" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:999px"/>
          <span id="dashLogoFallback">B</span>
        </div>
        <div id="sidebar-brand-name" class="sidebar-brand-name">Brand</div>
      </div>
      <nav id="sidebarNav" class="sidebar-nav">
        <button class="nav-item active" data-key="overview">Dashboard</button>
        <button class="nav-item" data-key="orders">Orders</button>
        <button class="nav-item" data-key="kitchen">Kitchen & SLA</button>
        <button class="nav-item" data-key="customers">Customers</button>
        <button class="nav-item" data-key="refunds">Refunds / Disputes</button>
        <button class="nav-item" data-key="products">Products</button>
        <button class="nav-item" data-key="staff">Staff</button>
        <button class="nav-item" data-key="devices">Devices</button>
        <button class="nav-item" data-key="reports">Reports</button>
        <button class="nav-item" data-key="settings">Settings</button>
</nav>
      <button id="btnSignOut" class="nav-item logout">Logout</button>
    </aside>

    <!-- MAIN -->
    <div style="flex:1;display:flex;flex-direction:column;">
      <header class="topbar">
        <div>
          <div id="brandTitle" class="topbar-title">Brand Dashboard</div>
          <div class="topbar-sub">Control center for your brand</div>
        </div>
        <div class="topbar-branch-filter">
          <span>Branch:</span>
          <select id="global-branch-select">
            <option value="global">All branches</option>
          </select>
        </div>
      </header>

      <main class="main">
  <div id="vendor-app-root">
<!-- APP -->
  <div id="app" class="hidden">
    <div class="tabs" id="tabs"></div>

    <!-- OVERVIEW -->
    <section class="card" id="page-overview">
      <div class="hd">
        <h2>Overview (Live)</h2>
        <div class="right">
          <span class="badge" id="periodBadge">Period: Today</span>
          <select id="periodSel">
            <option value="today" selected>Today</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="custom">Custom range</option>
          </select>
          <input id="fromDate" type="date" class="hidden">
          <input id="toDate" type="date" class="hidden">
          <button class="btn" id="btnRefresh">Refresh</button>
        </div>
      </div>
      <div class="bd">
        <div class="kpis" id="kpiGrid"></div>

        <div class="split" style="margin-top:14px">
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Trends</h2><span class="badge" id="peakChip">Peak: —</span></div>
            <div class="bd">
              <canvas id="ordersChart" height="120"></canvas>
              <div class="hr"></div>
              <canvas id="salesChart" height="120"></canvas>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Queue Health</h2><span class="badge b-ok" id="queueHealth">OK</span></div>
            <div class="bd">
              <div class="row">
                <div class="kpi">
                  <div class="t">Preparing</div>
                  <div class="v" id="prepCount">0</div>
                  <div class="s" id="prepOldest">Oldest: —</div>
                </div>
                <div class="kpi">
                  <div class="t">Completed (period)</div>
                  <div class="v" id="compCount">0</div>
                  <div class="s" id="avgPrep">Avg prep: —</div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="notice" id="alertsBox">No alerts.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ORDERS -->
    <section class="card hidden" id="page-orders">
      <div class="hd">
        <h2>Orders Center</h2>
        <div class="right">
          <select id="fStatus">
            <option value="all">All statuses</option>
            <option value="preparing">Preparing</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select id="fPay">
            <option value="all">All payments</option>
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="wallet">Wallet</option>
          </select>
          <select id="fRefund">
            <option value="all">All</option>
            <option value="refunded">Refunded only</option>
          </select>
          <button class="btn" id="btnExportCsv">Export CSV</button>
        </div>
      </div>
      <div class="bd">
        <div class="notice">Click an order to open details drawer. Actions include Cancel, Refund, Mark Completed (override), and Receipt QR preview.</div>
        <div style="overflow:auto;margin-top:10px">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Order #</th><th>Time</th><th>Status</th><th>Total</th><th>Payment</th><th>Customer</th><th>Prep time</th><th>Flags</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:14px;box-shadow:none" id="orderDrawer">
          <div class="hd">
            <h2 id="odTitle">Order details</h2>
            <div class="right">
              <button class="btn" id="btnOdReceipt">Open receipt</button>
              <button class="btn" id="btnOdComplete">Mark completed</button>
              <button class="btn danger" id="btnOdCancel">Cancel</button>
            </div>
          </div>
          <div class="bd">
            <div class="split">
              <div>
                <div id="odItems"></div>
                <div class="hr"></div>
                <div class="row">
                  <div class="field">
                    <label>Refund amount (leave empty = full)</label>
                    <input id="refundAmt" type="number" step="0.01" placeholder="e.g. 50">
                  </div>
                  <div class="field">
                    <label>Refund reason (optional)</label>
                    <input id="refundReason" placeholder="e.g. cancelled by customer">
                  </div>
                </div>
                <div style="margin-top:10px" class="right">
                  <button class="btn danger" id="btnOdRefund">Refund</button>
                  <button class="btn ghost" id="btnOdNote">Add internal note</button>
                </div>
              </div>
              <div>
                <div class="notice" id="odTimeline">Select an order…</div>
                <div class="hr"></div>
                <div class="notice">
                  <b>QR preview</b>
                  <div class="mini">Receipt URL is not stored in dashboard. QR uses <code>receipt.html?brandId=...&orderId=...</code></div>
                  <div id="odQr" style="margin-top:10px"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>


    <!-- KITCHEN & SLA -->
    <section class="card hidden" id="page-kitchen">
      <div class="hd">
        <h2>Kitchen & SLA</h2>
        <div class="right">
          <span class="badge" id="slaAvgChip">Avg prep: —</span>
          <div class="pillInput">
            <span class="mini">Stuck &gt;</span>
            <input id="slaStuckMin" type="number" min="1" value="20" style="width:90px" />
            <span class="mini">min</span>
          </div>
          <span class="badge b-warn" id="slaStuckChip">Stuck: 0</span>
          <button class="btn" id="btnSlaRefresh">Refresh</button>
        </div>
      </div>
      <div class="bd">
        <div class="split">
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Stuck / Preparing Queue</h2></div>
            <div class="bd">
              <div class="notice">Orders in <b>preparing</b> older than the stuck threshold appear here. You can <b>Mark completed</b> directly.</div>
              <div style="overflow:auto;margin-top:10px">
                <table id="slaTable">
                  <thead>
                    <tr>
                      <th>Order #</th><th>Created</th><th>Age</th><th>Total</th><th>Customer</th><th>Action</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Prep Time Analytics</h2></div>
            <div class="bd">
              <canvas id="prepByHourChart" height="140"></canvas>
              <div class="hr"></div>
              <div style="overflow:auto">
                <table id="prepByCatTable">
                  <thead><tr><th>Category</th><th>Avg prep</th><th>#Completed</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="mini" style="margin-top:8px">Prep time = completedAt − createdAt (completed orders in selected period).</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section class="card hidden" id="page-customers">
      <div class="hd">
        <h2>Customers</h2>
        <div class="right">
          <button class="btn" id="btnCustomersExport">Export CSV</button>
        </div>
      </div>
      <div class="bd">
        <div class="notice">
          Customers are <b>auto-created from orders</b> (name/phone if present, else Walk-in). Spend and order counts are calculated from live orders.
        </div>
        <div class="hr"></div>
        <div class="split">
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Top Customers</h2></div>
            <div class="bd" style="overflow:auto">
              <table id="topCustomersTable">
                <thead><tr><th>Customer</th><th>Phone</th><th>Orders</th><th>Spend</th><th>Last order</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>All Customers</h2></div>
            <div class="bd" style="overflow:auto">
              <table id="customersTable">
                <thead><tr><th>Customer</th><th>Phone</th><th>Orders</th><th>Spend</th><th>Last order</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- REFUNDS / DISPUTES -->
    <section class="card hidden" id="page-refunds">
      <div class="hd">
        <h2>Refunds / Disputes</h2>
        <div class="right">
          <span class="badge" id="refundsTotalChip">Total refunded: —</span>
          <button class="btn" id="btnRefundsExport">Export Refunds CSV</button>
        </div>
      </div>
      <div class="bd">
        <div class="notice">
          Refunds are recorded inside orders (<code>refund.at</code>, <code>refund.amount</code>, <code>refund.reason</code>). This page aggregates them for the selected period.
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="refundsTable">
            <thead><tr><th>Order #</th><th>Refund time</th><th>Amount</th><th>Reason</th><th>Cashier</th><th>Open order</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STAFF -->
    <section class="card hidden" id="page-staff">
      <div class="hd">
        <h2>Staff & Cashiers</h2>
        <div class="right">
          <button class="btn primary" id="btnAddStaff">Add staff</button>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field">
            <label>Username</label>
            <input id="staffUser" placeholder="e.g. cashier1">
          </div>
          <div class="field">
            <label>PIN</label>
            <input id="staffPin" placeholder="4-6 digits">
          </div>
          <div class="field">
            <label>Role</label>
            <select id="staffRole">
              <option value="cashier">Cashier (POS)</option>
              <option value="kitchen">Kitchen</option>
            </select>
          </div>
        </div>
        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnCreateStaff">Create</button>
          <button class="btn danger" id="btnClearStaff">Clear</button>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="staffTable">
            <thead><tr><th>Username</th><th>Role</th><th>Active</th><th>Created</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mini" id="staffMsg" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- DEVICES -->
    <section class="card hidden" id="page-devices">
      <div class="hd">
        <h2>Devices & Screens</h2>
        <div class="right">
          <button class="btn primary" id="btnAddDevice">Add device</button>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field"><label>Device name</label><input id="devName" placeholder="Kitchen-1"></div>
          <div class="field">
            <label>Role</label>
            <select id="devRole">
              <option value="pos">POS</option>
              <option value="kitchen">Kitchen</option>
              <option value="customer">Customer Display</option>
            </select>
          </div>
          <div class="field"><label>App version (optional)</label><input id="devVer" placeholder="1.0.0"></div>
        </div>
        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnCreateDevice">Create</button>
          <button class="btn danger" id="btnClearDevice">Clear</button>
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table id="devicesTable">
            <thead><tr><th>Name</th><th>Role</th><th>Locked</th><th>Last Online</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section class="card hidden" id="page-products">
      <div class="hd">
        <h2>Products & Menu</h2>
        <div class="right">
          <button class="btn" id="btnDownloadTemplate">Download Excel template (CSV)</button>
          <label class="btn" style="cursor:pointer">
            Import CSV/XLSX
            <input id="importFile" type="file" accept=".csv,.xlsx" style="display:none">
          </label>
          <button class="btn primary" id="btnAddProduct">Add product</button>
        </div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field"><label>Name</label><input id="pName" placeholder="Burger"></div>
          <div class="field"><label>Category</label><input id="pCat" placeholder="Sandwiches"></div>
          <div class="field"><label>Price</label><input id="pPrice" type="number" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field" style="flex:2"><label>Description (optional)</label><input id="pDesc" placeholder="Short description"></div>
          <div class="field">
            <label>Image</label>
            <input id="pImg" type="file" accept="image/*">
          </div>
        </div>
        <div class="right" style="margin-top:10px">
          <button class="btn primary" id="btnCreateProduct">Create</button>
          <button class="btn danger" id="btnClearProduct">Clear</button>
        </div>

        <div class="hr"></div>
        <div class="notice">
          Every product you add must have a <b>Delete</b> action (per your rule). Delete removes the  doc (and optionally the image reference).
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table id="productsTable">
            <thead><tr><th>Name</th><th>Category</th><th>Price</th><th>Image</th><th>Updated</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mini" id="prodMsg" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- REPORTS -->
    <section class="card hidden" id="page-reports">
      <div class="hd">
        <h2>Reports & Export Center</h2>
        <div class="right">
          <button class="btn" id="btnReportFinance">Finance CSV</button>
          <button class="btn" id="btnReportOps">Operations Print</button>
          <button class="btn primary" id="btnReportExec">Executive Print</button>
          <button class="btn" id="btnPrint">Print / Save PDF</button>
        </div>
      </div>
      <div class="bd">
        <div class="notice">
          Reports are generated from your live  data. Use <b>Print / Save PDF</b> to export charts + tables as a snapshot.
        </div>
        <div class="hr"></div>
        <div class="split">
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Executive Summary</h2></div>
            <div class="bd">
              <div class="kpis" id="repKpis"></div>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="hd"><h2>Issues / Alerts</h2></div>
            <div class="bd"><div class="notice" id="repAlerts">No alerts.</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="card hidden" id="page-settings">
      <div class="hd">
        <h2>Settings</h2>
        <div class="right">
          <button class="btn primary" id="btnSaveLinks">Save system links</button>
        </div>
      </div>
      <div class="bd">
        <div class="split">
          <div>
            <div class="card" style="box-shadow:none">
              <div class="hd"><h2>Branding</h2></div>
              <div class="bd">
                <div class="fileRow">
                  <div class="field" style="flex:1">
                    <label>Brand logo (for customer/receipt)</label>
                    <input id="brandLogoFile" type="file" accept="image/*">
                  </div>
                  <button class="btn" id="btnUploadBrandLogo">Upload</button>
                </div>
                <div class="hr"></div>
                <div class="fileRow">
                  <div class="field" style="flex:1">
                    <label>Dashboard logo (header)</label>
                    <input id="dashLogoFile" type="file" accept="image/*">
                  </div>
                  <button class="btn" id="btnUploadDashLogo">Upload</button>
                </div>
                <div class="mini" id="brandMsg" style="margin-top:8px"></div>
              </div>
            </div>

            <div class="card" style="margin-top:14px;box-shadow:none">
              <div class="hd"><h2>System Links</h2></div>
              <div class="bd">
                <div class="notice">Paste your deployed URLs here. (No receipt URL field per requirement.)</div>
                <div class="hr"></div>
                <div class="field"><label>POS URL</label><input id="linkPos" placeholder="https://.../pos.html"></div>
                <div class="field" style="margin-top:10px"><label>Kitchen URL</label><input id="linkKitchen" placeholder="https://.../kitchen.html"></div>
                <div class="field" style="margin-top:10px"><label>Customer Display URL</label><input id="linkCustomer" placeholder="https://.../customer.html"></div>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="box-shadow:none">
              <div class="hd"><h2>Danger Zone</h2></div>
              <div class="bd">
                <div class="notice dangerText">
                  Delete actions are available per your rule. Use carefully.
                </div>
                <div class="hr"></div>
                <button class="btn danger" id="btnDeleteAllOrders">Cancel ALL orders (vendor)</button>
                <div class="mini" style="margin-top:8px">This only deletes order documents, not  files.</div>
              </div>
            </div>

            <div class="card" style="margin-top:14px;box-shadow:none">
              <div class="hd"><h2>Runtime Health</h2></div>
              <div class="bd">
                <div class="notice">
                  The dashboard auto-creates:
                  <ul class="mini">
                   <li><code>brands/{brandId}</code></li>
                   <li><code>brands/{brandId}/runtime/customerDisplay</code></li>
                   <li><code>brands/{brandId}/settings/links</code></li>
                  </ul>
                </div>
                <button class="btn" id="btnHeal">Heal / Create missing docs</button>
                <div class="mini" id="healMsg" style="margin-top:8px"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </div>
</div>


  </div>
</main>
    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-container"></div>

  
<div class="footer">Powered by Luma</div>

<!-- Chart.js (required for charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script type="module">

  /**************************************************************
   * 1) PASTE YOUR FIREBASE CONFIG HERE
   **************************************************************/
  const firebaseConfig = {
    apiKey:"AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
    authDomain:"events-339ce.firebaseapp.com",
    databaseURL:"https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"events-339ce",
    storageBucket:"events-339ce.firebasestorage.app",
    messagingSenderId:"175601544315",
    appId:"1:175601544315:web:00c94b4affa972b3a286de"
  
  };

  /**************************************************************
   * 2) Imports
   **************************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, setDoc, updateDoc, deleteDoc,
    collection, addDoc, serverTimestamp,
    query, where, orderBy, limit, getDocs, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  /**************************************************************
   * 3) App init
   **************************************************************/
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  /**************************************************************
   * 4) Helpers
   **************************************************************/
  const __idFallback = {
  email:["login-email","owner-email"],
  pass:["login-password","owner-password"],
  brandId:["create-brandId","brand-key"],
  brandName:["brand-name","create-brandName"],
  authMsg:["auth-alert-container","auth-error"],
  btnSignin:["login-btn","btn-login"],
  btnSignup:["create-btn","btn-create-brand"],
};
const $ = (id)=>{
  const primary = document.getElementById(id);
  if(primary) return primary;
  const alts = __idFallback[id];
  if(alts){
    for(const a of alts){ const el=document.getElementById(a); if(el) return el; }
  }
  return null;
};
  const fmtMoney = (n)=> (Number(n||0)).toFixed(2);
  const now = ()=> new Date();
  const toISODate = (d)=> d.toISOString().slice(0,10);
  function safeId(s){
    return String(s||"").trim().toLowerCase().replace(/[^a-z0-9_-]/g,"_").slice(0,64);
  }
  function msToHuman(ms){
    if(!isFinite(ms) || ms<0) return "—";
    const m = Math.floor(ms/60000);
    if(m<1) return "< 1m";
    if(m<60) return `${m}m`;
    const h = Math.floor(m/60);
    const rm = m%60;
    return `${h}h ${rm}m`;
  }
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  function toast(msg, ok=true){
    const el = $("authMsg");
    el.textContent = msg;
    el.style.color = ok ? "#a7f3d0" : "#ffb4c0";
  }
  function setAuthPill(text){
    $("authPill").textContent = text;
  }

  /**************************************************************
   * Print helpers (PDF export that includes charts)
   **************************************************************/
  let CURRENT_PAGE = "overview";
  let __printSwaps = [];

  function setPrintAreaByKey(key){
    // remove previous
    document.querySelectorAll(".print-area").forEach(el=>el.classList.remove("print-area"));
    const section = document.getElementById("page-"+key);
    if(section) section.classList.add("print-area");
  }

  function swapCanvasToImages(container){
    __printSwaps = [];
    if(!container) return;
    const canvases = container.querySelectorAll("canvas");
    canvases.forEach(cv=>{
      try{
        const img = document.createElement("img");
        img.alt = "chart";
        img.style.maxWidth = "100%";
        img.style.display = "block";
        img.style.borderRadius = "12px";
        img.src = cv.toDataURL("image/png", 1.0);
        cv.style.display = "none";
        cv.parentNode.insertBefore(img, cv.nextSibling);
        __printSwaps.push({canvas:cv, img});
      }catch(e){
        // ignore chart swap failures
      }
    });
  }

  function restoreCanvasSwaps(){
    __printSwaps.forEach(({canvas,img})=>{
      try{ if(img && img.parentNode) img.parentNode.removeChild(img); }catch(e){}
      try{ if(canvas) canvas.style.display = ""; }catch(e){}
    });
    __printSwaps = [];
  }

  window.addEventListener("beforeprint", ()=>{
    setPrintAreaByKey(CURRENT_PAGE);
    swapCanvasToImages(document.querySelector(".print-area"));
  });
  window.addEventListener("afterprint", ()=>{
    restoreCanvasSwaps();
  });


  
  function customerKeyFromOrder(o){
    const phone = String(o?.customer?.phone||"").trim();
    const name = String(o?.customer?.name||"").trim();
    if(phone) return "p_"+safeId(phone);
    if(name) return "n_"+safeId(name);
    return "walkin";
  }

  async function upsertCustomerFromOrder(o){
    try{
      const key = customerKeyFromOrder(o);
      const name = String(o?.customer?.name||"").trim() || (key==="walkin" ? "Walk-in" : null);
      const phone = String(o?.customer?.phone||"").trim() || null;

      const created = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const total = Number(o?.totals?.total||0);
      // Only count non-cancelled orders toward spend
      const isSale = o?.status !== "cancelled";

      await setDoc(doc(db,"brands",BRAND_ID,"customers",key), {
        key,
        name,
        phone,
        lastOrderAt: created || null,
        updatedAt: serverTimestamp()
      }, {merge:true});
    }catch(e){
      // Never crash on customer writes
      console.warn("upsertCustomerFromOrder failed", e);
    }
  }

/**************************************************************
   * 5) State
   **************************************************************/
  let BRAND_ID = null;
  let BRAND = null;
  let unsubOrders = null;
  let unsubStaff = null;
  let unsubDevices = null;
  let unsubProducts = null;

  let ordersCache = [];
  let productsCache = [];
  let staffCache = [];
  let devicesCache = [];
  let selectedOrder = null;

  // Charts (global)
  let ordersChart = null;
  let salesChart = null;
  let prepByHourChart = null;




  /**************************************************************
   * 6) Doc refs
   **************************************************************/
  const brandRef = ()=> doc(db, "brands", BRAND_ID);
  const runtimeRef = ()=> doc(db, "brands", BRAND_ID, "runtime", "customerDisplay");
  const linksRef = ()=> doc(db, "brands", BRAND_ID, "settings", "links");

  const ordersCol = ()=> collection(db, "brands", BRAND_ID, "orders");
  const productsCol = ()=> collection(db, "brands", BRAND_ID, "products");
  const staffCol = ()=> collection(db, "brands", BRAND_ID, "staff");
  const devicesCol = ()=> collection(db, "brands", BRAND_ID, "devices");

  const customersCol = ()=> collection(db, "brands", BRAND_ID, "customers");


  /**************************************************************
   * 7) Auto-heal / create missing docs
   **************************************************************/
  async function heal(){
    if(!BRAND_ID) return;
    const b = await getDoc(brandRef());
    if(!b.exists()){
      await setDoc(brandRef(), {
        name: BRAND?.name || $("brandName").value.trim() || "Vendor",
        ownerUid: auth.currentUser?.uid || null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});
    }
    const r = await getDoc(runtimeRef());
    if(!r.exists()){
      await setDoc(runtimeRef(), { lastPaidOrderId:null, lastPaidAt:null, updatedAt:serverTimestamp() }, {merge:true});
    }
    const l = await getDoc(linksRef());
    if(!l.exists()){
      await setDoc(linksRef(), { posUrl:"", kitchenUrl:"", customerUrl:"", updatedAt:serverTimestamp() }, {merge:true});
    }
    $("healMsg").textContent = "Heal complete.";
  }

  /**************************************************************
   * 8) Auth actions (AUTO LOGIN + AUTO BRAND RESOLVE)
   **************************************************************/
  const LS_KEYS = {
    brandId: "luma.vendor.brandId",
    lastEmail: "luma.vendor.lastEmail"
  };

  function setAuthAlert(msg, kind="info"){
    const c = document.getElementById("auth-alert-container");
    if(!c) return;
    if(!msg){ c.innerHTML=""; return; }
    const cls = kind==="error" ? "auth-alert auth-alert-error" : "auth-alert auth-alert-info";
    c.innerHTML = `<div class="${cls}">${msg}</div>`;
  }

  function showAuthTab(which){
    const loginTab = document.getElementById("tab-login");
    const createTab = document.getElementById("tab-create");
    const loginForm = document.getElementById("login-form");
    const createForm = document.getElementById("create-form");
    if(!loginTab||!createTab||!loginForm||!createForm) return;
    const isLogin = which==="login";
    loginTab.classList.toggle("active", isLogin);
    createTab.classList.toggle("active", !isLogin);
    loginForm.style.display = isLogin ? "block" : "none";
    createForm.style.display = isLogin ? "none" : "block";
  }

  document.getElementById("tab-login")?.addEventListener("click", ()=>showAuthTab("login"));
  document.getElementById("tab-create")?.addEventListener("click", ()=>showAuthTab("create"));

  function persistBrandId(id){
    if(id) localStorage.setItem(LS_KEYS.brandId, id);
  }
  function readBrandId(){
    return localStorage.getItem(LS_KEYS.brandId) || null;
  }

  async function resolveBrandIdForUser(uid){
    if(BRAND_ID) return BRAND_ID;

    // 1) cached
    const cached = readBrandId();
    if(cached){
      BRAND_ID = cached;
      return BRAND_ID;
    }

    // 2) find by ownerUid
    const q1 = query(collection(db, "brands"), where("ownerUid","==", uid), limit(1));
    const snap = await getDocs(q1);
    if(!snap.empty){
      BRAND_ID = snap.docs[0].id;
      persistBrandId(BRAND_ID);
      return BRAND_ID;
    }
    return null;
  }

  async function createUniqueBrandId(base){
    let id = safeId(base);
    if(!id) id = "brand";
    const uid = auth.currentUser?.uid || "";
    const suffix = uid ? ("_" + uid.slice(0,6)) : ("_" + Math.random().toString(16).slice(2,6));
    id = (id + suffix).slice(0,64);

    let tries = 0;
    while(tries < 6){
      const test = await getDoc(doc(db, "brands", id));
      if(!test.exists()) return id;
      id = (safeId(base) + "_" + Math.random().toString(16).slice(2,8)).slice(0,64);
      tries++;
    }
    return id;
  }

  // Login
  document.getElementById("login-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    setAuthAlert("");
    try{
      const email = document.getElementById("login-email")?.value?.trim() || "";
      const pass  = document.getElementById("login-password")?.value || "";
      if(!email || !pass) return setAuthAlert("Enter email + password.", "error");
      localStorage.setItem(LS_KEYS.lastEmail, email);
      await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged finishes
    }catch(err){
      console.error(err);
      setAuthAlert(err?.message || "Sign in failed.", "error");
    }
  });

  // Create brand
  document.getElementById("create-form")?.addEventListener("submit", async (e)=>{
    e.preventDefault();
    setAuthAlert("");
    try{
      const brandName = document.getElementById("brand-name")?.value?.trim() || "Vendor";
      const country   = document.getElementById("brand-country")?.value?.trim() || "";
      const ownerName = document.getElementById("owner-name")?.value?.trim() || "";
      const email     = document.getElementById("owner-email")?.value?.trim() || "";
      const pass      = document.getElementById("owner-password")?.value || "";

      if(!email || !pass) return setAuthAlert("Enter email + password.", "error");
      if(pass.length < 6) return setAuthAlert("Password must be at least 6 characters.", "error");

      localStorage.setItem(LS_KEYS.lastEmail, email);

      await createUserWithEmailAndPassword(auth, email, pass);

      BRAND_ID = await createUniqueBrandId(brandName);
      persistBrandId(BRAND_ID);

      await setDoc(brandRef(), {
        name: brandName,
        country: country || null,
        ownerName: ownerName || null,
        ownerUid: auth.currentUser?.uid || null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});

      await heal();
      setAuthAlert("Brand created. You're signed in.", "info");
      // onAuthStateChanged finishes
    }catch(err){
      console.error(err);
      setAuthAlert(err?.message || "Create brand failed.", "error");
    }
  });

  // Logout
  document.getElementById("btnSignOut")?.addEventListener("click", async ()=>{
    try{
      await signOut(auth);
    }catch(e){ console.warn(e); }
  });

  // Auto-login: Firebase already persists session, we just auto-resolve BRAND_ID
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      BRAND_ID = null;
      BRAND = null;
      teardownRealtime();

      document.getElementById("authCard")?.classList.remove("hidden");
      const appView = document.getElementById("app-view");
      if(appView){ appView.style.display = "none"; }
      document.getElementById("app")?.classList.add("hidden");

      showAuthTab("login");
      const lastEmail = localStorage.getItem(LS_KEYS.lastEmail);
      if(lastEmail){
        const le = document.getElementById("login-email");
        if(le && !le.value) le.value = lastEmail;
      }
      return;
    }

    // Resolve brand id
    const resolved = await resolveBrandIdForUser(user.uid);
    if(!resolved){
      // This account has no brand yet (or local cache is empty)
      await signOut(auth);
      showAuthTab("create");
      setAuthAlert("No brand found for this account. Please create your brand.", "error");
      return;
    }

    // Ensure brand doc exists (no DB touch rule)
    const b = await getDoc(brandRef());
    if(!b.exists()){
      await setDoc(brandRef(), {
        name: "Vendor",
        ownerUid: user.uid,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});
    }
    const b2 = await getDoc(brandRef());
    BRAND = { id: BRAND_ID, ...(b2.data()||{}) };
    persistBrandId(BRAND_ID);

    // Switch views
    document.getElementById("authCard")?.classList.add("hidden");
    const appView = document.getElementById("app-view");
    if(appView){ appView.style.display = "flex"; }
    document.getElementById("app")?.classList.remove("hidden");

    // Header names
    const sbn = document.getElementById("sidebar-brand-name");
    if(sbn) sbn.textContent = BRAND?.name || "Brand";
const tbt = document.getElementById("brandTitle");
if(tbt) tbt.textContent = BRAND?.name ? `${BRAND.name} — Dashboard` : "Brand Dashboard";
    if(tbt) tbt.textContent = BRAND?.name ? `${BRAND.name} — Dashboard` : "Brand Dashboard";

    await heal();
    await loadSettingsBranding();
    setupTabs();
    bindSidebarNav();
    startRealtime();
  });
/**************************************************************
   * 9) Tabs
   **************************************************************/
  const PAGES = [
    ["overview","Overview"],
    ["orders","Orders"],
    ["kitchen","Kitchen & SLA"],
    ["customers","Customers"],
    ["refunds","Refunds / Disputes"],
    ["products","Products"],
    ["staff","Staff"],
    ["devices","Devices"],
    ["reports","Reports"],
    ["settings","Settings"]
  ];

  function setupTabs(){
    const el = $("tabs");
    el.innerHTML = "";
    PAGES.forEach(([key,label], idx)=>{
      const b = document.createElement("button");
      b.className = "tab" + (idx===0 ? " active" : "");
      b.textContent = label;
      b.onclick = ()=> showPage(key);
      el.appendChild(b);
    });
    showPage("overview");
  }

  function bindSidebarNav(){
    const nav = document.getElementById("sidebarNav");
    if(!nav) return;
    nav.querySelectorAll(".nav-item[data-key]").forEach(btn=>{
      btn.onclick = ()=>{
        // active styling
        nav.querySelectorAll(".nav-item").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        showPage(btn.dataset.key);
      };
    });
  }

  function showPage(key){
    CURRENT_PAGE = key;
    setPrintAreaByKey(key);
    // tabs
    [...$("tabs").children].forEach((t,i)=>{
      t.classList.toggle("active", PAGES[i][0]===key);
    });
    // pages
    PAGES.forEach(([k])=>{
      $("page-"+k).classList.toggle("hidden", k!==key);
    });
    // Special: refresh some views
    if(key==="reports") renderReportView();
    if(key==="kitchen") renderKitchenSLA();
    if(key==="customers") renderCustomers();
    if(key==="refunds") renderRefunds();
  }

  /**************************************************************
   * 10) Settings: branding + links
   **************************************************************/
  async function loadSettingsBranding(){
    const b = await getDoc(brandRef());
    const d = b.data()||{};
    if(d.dashboardLogoUrl){
      $("dashLogoImg").src = d.dashboardLogoUrl;
      $("dashLogoImg").style.display = "block";
      $("dashLogoFallback").style.display = "none";
    }else{
      $("dashLogoImg").style.display = "none";
      $("dashLogoFallback").style.display = "block";
    }

    const l = await getDoc(linksRef());
    if(l.exists()){
      const v = l.data()||{};
      $("linkPos").value = v.posUrl||"";
      $("linkKitchen").value = v.kitchenUrl||"";
      $("linkCustomer").value = v.customerUrl||"";
    }
  }

  async function uploadImage(file, path){
    const r = sRef(storage, path);
    await uploadBytes(r, file);
    return await getDownloadURL(r);
  }

  $("btnUploadBrandLogo").onclick = async ()=>{
    const f = $("brandLogoFile").files?.[0];
    if(!f) return $("brandMsg").textContent = "Pick a file first.";
    $("brandMsg").textContent = "Uploading…";
    try{
      const url = await uploadImage(f, `brands/${BRAND_ID}/branding/brandLogo_${Date.now()}`);
      await updateDoc(brandRef(), { logoUrl:url, updatedAt:serverTimestamp() });
      $("brandMsg").textContent = "Brand logo updated.";
    }catch(e){
      console.error(e);
      $("brandMsg").textContent = e.message || "Upload failed.";
    }
  };

  $("btnUploadDashLogo").onclick = async ()=>{
    const f = $("dashLogoFile").files?.[0];
    if(!f) return $("brandMsg").textContent = "Pick a file first.";
    $("brandMsg").textContent = "Uploading…";
    try{
      const url = await uploadImage(f, `brands/${BRAND_ID}/branding/dashboardLogo_${Date.now()}`);
      await updateDoc(brandRef(), { dashboardLogoUrl:url, updatedAt:serverTimestamp() });
      $("brandMsg").textContent = "Dashboard logo updated.";
      await loadSettingsBranding();
    }catch(e){
      console.error(e);
      $("brandMsg").textContent = e.message || "Upload failed.";
    }
  };

  $("btnSaveLinks").onclick = async ()=>{
    try{
      await setDoc(linksRef(), {
        posUrl: $("linkPos").value.trim(),
        kitchenUrl: $("linkKitchen").value.trim(),
        customerUrl: $("linkCustomer").value.trim(),
        updatedAt: serverTimestamp()
      }, {merge:true});
      alert("Links saved.");
    }catch(e){
      alert(e.message || "Failed to save links.");
    }
  };

  $("btnHeal").onclick = heal;

  /**************************************************************
   * 11) Realtime listeners
   **************************************************************/
  function teardownRealtime(){
    if(unsubOrders) unsubOrders();
    if(unsubProducts) unsubProducts();
    if(unsubStaff) unsubStaff();
    if(unsubDevices) unsubDevices();
    unsubOrders = unsubProducts = unsubStaff = unsubDevices = null;
    ordersCache = productsCache = staffCache = devicesCache = [];
  }

  function startRealtime(){
    teardownRealtime();

    // Orders: recent
    const oq = query(ordersCol(), orderBy("timestamps.createdAt","desc"), limit(400));
    unsubOrders = onSnapshot(oq, async (snap)=>{
      // Upsert customers from changed orders (best-effort; never blocks UI)
      const changes = snap.docChanges();
      for(const ch of changes){
        if(ch.type==="removed") continue;
        const o = {id: ch.doc.id, ...ch.doc.data()};
        await upsertCustomerFromOrder(o);
      }

      ordersCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderOverview();
      renderOrdersTable();
      renderKitchenSLA();
      renderCustomers();
      renderRefunds();
      renderReportView();
    });

    // Products
    const pq = query(productsCol(), orderBy("updatedAt","desc"), limit(1000));
    unsubProducts = onSnapshot(pq, (snap)=>{
      productsCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderProductsTable();
    });

    // Staff
    const sq = query(staffCol(), orderBy("createdAt","desc"), limit(500));
    unsubStaff = onSnapshot(sq, (snap)=>{
      staffCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderStaffTable();
    });

    // Devices
    const dq = query(devicesCol(), orderBy("updatedAt","desc"), limit(500));
    unsubDevices = onSnapshot(dq, (snap)=>{
      devicesCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
      renderDevicesTable();
    });
  }

  /**************************************************************
   * 12) Period filtering
   **************************************************************/
  function getPeriodRange(){
    const mode = $("periodSel").value;
    const end = new Date();
    let start = new Date(end);
    if(mode==="today"){
      start = new Date(end.getFullYear(), end.getMonth(), end.getDate());
    }else if(mode==="7d"){
      start.setDate(start.getDate()-6);
      start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
    }else if(mode==="30d"){
      start.setDate(start.getDate()-29);
      start = new Date(start.getFullYear(), start.getMonth(), start.getDate());
    }else{
      const f = $("fromDate").value ? new Date($("fromDate").value+"T00:00:00") : new Date(end.getFullYear(), end.getMonth(), end.getDate());
      const t = $("toDate").value ? new Date($("toDate").value+"T23:59:59") : end;
      start = f; end.setTime(t.getTime());
      return {start, end, mode:"custom"};
    }
    return {start, end, mode};
  }

  $("periodSel").onchange = ()=>{
    const isCustom = $("periodSel").value==="custom";
    $("fromDate").classList.toggle("hidden", !isCustom);
    $("toDate").classList.toggle("hidden", !isCustom);
    renderOverview();
  };
  $("btnRefresh").onclick = renderOverview;

  /**************************************************************
   * 13) Overview rendering + charts + alerts
   **************************************************************/
  function inRangeOrder(o, start, end){
    const ts = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
    if(!ts) return false;
    return ts >= start && ts <= end;
  }

  
  function calcRefundAmount(o){
    const total = Number(o?.totals?.total||0);
    const r = o?.refund;
    if(!r || !r.at) return 0;

    // POS-compatible refund schema:
    // - full refund: refund.full === true OR refund.mode === "full"
    // - partial refund by items: refund.items = [{name, qty, unitPrice}]
    // - optional amount-based refund: refund.amount
    if(r.full === true || String(r.mode||"").toLowerCase()==="full") return total;

    if(Array.isArray(r.items) && r.items.length){
      const sum = r.items.reduce((a,it)=>{
        const qty = Number(it?.qty||0);
        const up = Number(it?.unitPrice||it?.price||0);
        return a + (qty*up);
      },0);
      return Math.max(0, sum);
    }

    if(r.amount!=null && r.amount!=="" && isFinite(Number(r.amount))) return Math.max(0, Number(r.amount));

    // Fallback: treat as full if we can't interpret
    return total;
  }

  function calcNetTotal(o){
    const total = Number(o?.totals?.total||0);
    const refunded = calcRefundAmount(o);
    return Math.max(0, total - refunded);
  }


  function renderOverview(){
    if(!ordersCache) return;
    const {start, end, mode} = getPeriodRange();
    $("periodBadge").textContent = mode==="custom"
      ? `Period: ${$("fromDate").value||"—"} → ${$("toDate").value||"—"}`
      : `Period: ${$("periodSel").selectedOptions[0].textContent}`;

    const orders = ordersCache.filter(o=> inRangeOrder(o,start,end));
    const validSalesOrders = orders.filter(o=> o.status!=="cancelled");

    const totalSales = validSalesOrders.reduce((a,o)=>a+Number(o?.totals?.total||0),0);
    const ordersCount = validSalesOrders.length;
    const aov = ordersCount ? totalSales/ordersCount : 0;

        const refundsAmt = validSalesOrders.reduce((a,o)=> a + calcRefundAmount(o), 0);

    const netSales = validSalesOrders.reduce((a,o)=>a+calcNetTotal(o),0);

    const preparingCount = orders.filter(o=>o.status==="preparing").length;
    const completedCount = orders.filter(o=>o.status==="completed").length;
    const cancelledCount = orders.filter(o=>o.status==="cancelled").length;

    const paySplit = {cash:0, card:0, wallet:0};
    validSalesOrders.forEach(o=>{
      const m = (o?.payment?.method||"").toLowerCase();
      if(paySplit[m]!=null) paySplit[m]+=Number(o?.totals?.total||0);
    });

    // KPI cards
    const kpis = [
      ["Total Sales", fmtMoney(totalSales), "Excluding cancelled"],
      ["Orders", String(ordersCount), "Paid orders"],
      ["AOV", fmtMoney(aov), "Average order value"],
      ["Net Sales", fmtMoney(netSales), "After refunds"],
      ["Refunds", fmtMoney(refundsAmt), "Period refunds"],
      ["Open Orders", String(preparingCount), "Preparing"],
      ["Cancelled", String(cancelledCount), "Period cancelled"],
      ["Cash / Card / Wallet", `${fmtMoney(paySplit.cash)} / ${fmtMoney(paySplit.card)} / ${fmtMoney(paySplit.wallet)}`, "Payment split"]
    ];
    $("kpiGrid").innerHTML = kpis.map(([t,v,s])=>`
      <div class="kpi">
        <div class="t">${t}</div>
        <div class="v">${v}</div>
        <div class="s">${s}</div>
      </div>
    `).join("");

    // Queue health: oldest preparing
    const preparing = ordersCache.filter(o=>o.status==="preparing");
    let oldestAge = null;
    preparing.forEach(o=>{
      const t = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      if(!t) return;
      const age = Date.now() - t.getTime();
      if(oldestAge==null || age>oldestAge) oldestAge = age;
    });
    $("prepCount").textContent = String(preparing.length);
    $("prepOldest").textContent = `Oldest: ${msToHuman(oldestAge??NaN)}`;
    $("compCount").textContent = String(completedCount);

    // Avg prep time (created -> completed)
    const prepTimes = orders.filter(o=>o.status==="completed").map(o=>{
      const c = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const d = o?.timestamps?.completedAt?.toDate ? o.timestamps.completedAt.toDate() : null;
      if(!c || !d) return null;
      return d.getTime() - c.getTime();
    }).filter(x=>x!=null);
    const avgPrep = prepTimes.length ? prepTimes.reduce((a,x)=>a+x,0)/prepTimes.length : null;
    $("avgPrep").textContent = `Avg prep: ${msToHuman(avgPrep??NaN)}`;

    // Alerts
    const alerts = [];
    const stuckThresholdMin = Number($("slaStuckMin")?.value || 20);
    const stuckCount = preparing.filter(o=>{
      const t = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      if(!t) return false;
      return (Date.now()-t.getTime()) > stuckThresholdMin*60000;
    }).length;
    if(stuckCount>=10) alerts.push(`⚠️ ${stuckCount} orders stuck in Preparing for > ${stuckThresholdMin} min`);

    // High refund spike (simple heuristic)
        const refundedOrdersCount = validSalesOrders.filter(o=>o?.refund?.at).length;
    const refundRate = ordersCount ? (refundedOrdersCount / ordersCount) : 0;
        if(refundRate >= 0.08 && refundedOrdersCount >= 3){
      alerts.push(`⚠️ Refund spike: ${(refundRate*100).toFixed(1)}% of orders refunded`);
    }

    $("alertsBox").textContent = alerts.length ? alerts.join(" • ") : "No alerts.";
    $("alertsBox").className = "notice" + (alerts.length ? " dangerText" : "");
    $("repAlerts").textContent = alerts.length ? alerts.join("\n") : "No alerts.";

    // Queue health badge
    if(stuckCount>=10) { $("queueHealth").textContent="Needs attention"; $("queueHealth").className="badge b-bad"; }
    else if(stuckCount>0) { $("queueHealth").textContent="Watch"; $("queueHealth").className="badge b-warn"; }
    else { $("queueHealth").textContent="OK"; $("queueHealth").className="badge b-ok"; }
    // Charts
    // group by hour
    const hours = new Map(); // key: YYYY-MM-DD HH
    orders.forEach(o=>{
      const t = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      if(!t) return;
      const key = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:00`;
      const rec = hours.get(key) || {orders:0,sales:0};
      if(o.status!=="cancelled"){
        rec.orders += 1;
        rec.sales += Number(o?.totals?.total||0);
      }
      hours.set(key, rec);
    });
    const labels = [...hours.keys()].sort();
    const ordSeries = labels.map(k=>hours.get(k).orders);
    const salesSeries = labels.map(k=>hours.get(k).sales);

    // Peak chip
    let peakIdx = -1; let peakVal = -1;
    ordSeries.forEach((v,i)=>{ if(v>peakVal){peakVal=v; peakIdx=i;}});
    $("peakChip").textContent = peakIdx>=0 ? `Peak: ${labels[peakIdx]}` : "Peak: —";

    // Render charts
    const oc = $("ordersChart").getContext("2d");
    const sc = $("salesChart").getContext("2d");
    if(ordersChart) ordersChart.destroy();
    if(salesChart) salesChart.destroy();

    ordersChart = new Chart(oc, {
      type:"line",
      data:{ labels, datasets:[{ label:"Orders/hour", data: ordSeries, tension:.35 }]},
      options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ x:{ticks:{color:"#a9b6d6"}}, y:{ticks:{color:"#a9b6d6"}} } }
    });
    salesChart = new Chart(sc, {
      type:"line",
      data:{ labels, datasets:[{ label:"Sales/hour", data: salesSeries, tension:.35 }]},
      options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ x:{ticks:{color:"#a9b6d6"}}, y:{ticks:{color:"#a9b6d6"}} } }
    });

    // Reports KPIs mirror overview
    $("repKpis").innerHTML = kpis.slice(0,6).map(([t,v,s])=>`
      <div class="kpi"><div class="t">${t}</div><div class="v">${v}</div><div class="s">${s}</div></div>
    `).join("");
  }

  
  /**************************************************************
   * 13b) Kitchen & SLA / Customers / Refunds rendering
   **************************************************************/
  function renderKitchenSLA(){
    const tbody = $("slaTable")?.querySelector("tbody");
    if(!tbody) return;

    const {start, end} = getPeriodRange();
    const stuckMin = Number($("slaStuckMin")?.value||20);
    const stuckMs = Math.max(1, stuckMin) * 60000;

    const preparing = ordersCache.filter(o=>o.status==="preparing");
    const nowMs = Date.now();

    const stuck = preparing.map(o=>{
      const created = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const age = created ? (nowMs - created.getTime()) : NaN;
      return {o, created, age};
    }).filter(x=>isFinite(x.age) && x.age > stuckMs).sort((a,b)=>b.age-a.age);

    $("slaStuckChip").textContent = `Stuck: ${stuck.length}`;
    tbody.innerHTML = stuck.map(x=>{
      const o = x.o;
      const orderNo = o.orderNumber || o.shortId || o.id.slice(-6);
      return `
        <tr>
          <td><b>#${orderNo}</b></td>
          <td class="muted">${tsToStr(o?.timestamps?.createdAt)}</td>
          <td class="muted">${msToHuman(x.age)}</td>
          <td>${fmtMoney(o?.totals?.total)}</td>
          <td class="muted">${o?.customer?.name||"—"}</td>
          <td><button class="btn" data-act="complete" data-id="${o.id}">Mark completed</button></td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="6" class="muted">No stuck orders.</td></tr>`;

    tbody.querySelectorAll("button[data-act='complete']").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        if(!confirm("Mark this order as completed?")) return;
        await updateDoc(doc(db,"brands",BRAND_ID,"orders",id), {
          status:"completed",
          "timestamps.completedAt": serverTimestamp(),
          "timestamps.updatedAt": serverTimestamp()
        });
      };
    });

    // Avg prep in period
    const prepTimes = ordersCache.filter(o=>o.status==="completed" && inRangeOrder(o,start,end)).map(o=>{
      const c = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const d = o?.timestamps?.completedAt?.toDate ? o.timestamps.completedAt.toDate() : null;
      if(!c || !d) return null;
      return d.getTime() - c.getTime();
    }).filter(x=>x!=null);

    const avg = prepTimes.length ? prepTimes.reduce((a,x)=>a+x,0)/prepTimes.length : null;
    $("slaAvgChip").textContent = `Avg prep: ${msToHuman(avg??NaN)}`;

    // Prep by hour (completed orders)
    const hourMap = new Map();
    ordersCache.filter(o=>o.status==="completed" && inRangeOrder(o,start,end)).forEach(o=>{
      const c = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const d = o?.timestamps?.completedAt?.toDate ? o.timestamps.completedAt.toDate() : null;
      if(!c || !d) return;
      const hr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:00`;
      const ms = d.getTime()-c.getTime();
      const rec = hourMap.get(hr) || {sum:0,count:0};
      rec.sum += ms; rec.count += 1;
      hourMap.set(hr, rec);
    });
    const labels = [...hourMap.keys()].sort();
    const series = labels.map(k=>{
      const r = hourMap.get(k);
      return r.count ? Math.round(r.sum/r.count/60000) : 0; // minutes
    });
    const ctx = $("prepByHourChart")?.getContext("2d");
    if(ctx){
      if(prepByHourChart) prepByHourChart.destroy();
      prepByHourChart = new Chart(ctx, {
        type:"bar",
        data:{ labels, datasets:[{ label:"Avg prep (minutes) by hour", data: series }]},
        options:{ responsive:true, plugins:{legend:{display:true}}, scales:{ x:{ticks:{color:"#a9b6d6"}}, y:{ticks:{color:"#a9b6d6"}} } }
      });
    }

    // Prep by category (best-effort using order items)
    const catMap = new Map();
    ordersCache.filter(o=>o.status==="completed" && inRangeOrder(o,start,end)).forEach(o=>{
      const c = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const d = o?.timestamps?.completedAt?.toDate ? o.timestamps.completedAt.toDate() : null;
      if(!c || !d) return;
      const ms = d.getTime()-c.getTime();
      const cats = new Set();
      (o.items||[]).forEach(it=>{
        const cat = String(it.category||it.cat||"").trim();
        if(cat) cats.add(cat);
      });
      if(cats.size===0) cats.add("Uncategorized");
      cats.forEach(cat=>{
        const rec = catMap.get(cat) || {sum:0,count:0};
        rec.sum += ms; rec.count += 1;
        catMap.set(cat, rec);
      });
    });
    const catTbody = $("prepByCatTable")?.querySelector("tbody");
    if(catTbody){
      const cats = [...catMap.entries()].map(([cat,rec])=>({
        cat,
        avg: rec.count ? rec.sum/rec.count : null,
        n: rec.count
      })).sort((a,b)=>(b.n-a.n));
      catTbody.innerHTML = cats.map(x=>`
        <tr>
          <td><b>${x.cat}</b></td>
          <td class="muted">${msToHuman(x.avg??NaN)}</td>
          <td class="muted">${x.n}</td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="muted">No completed orders in period.</td></tr>`;
    }
  }

  function buildCustomersFromOrders(){
    const {start, end} = getPeriodRange();
    const map = new Map(); // key -> {name, phone, spend, orders, lastAt}
    ordersCache.filter(o=>inRangeOrder(o,start,end) && o.status!=="cancelled").forEach(o=>{
      const name = String(o?.customer?.name||"").trim() || "Walk-in";
      const phone = String(o?.customer?.phone||"").trim() || "";
      const key = phone ? ("p_"+phone) : ("n_"+name);
      const created = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const total = Number(o?.totals?.total||0);

      const rec = map.get(key) || {name, phone: phone||"—", spend:0, orders:0, lastAt:null};
      rec.name = name;
      rec.phone = phone ? phone : (rec.phone||"—");
      rec.spend += total;
      rec.orders += 1;
      if(created && (!rec.lastAt || created>rec.lastAt)) rec.lastAt = created;
      map.set(key, rec);
    });
    return [...map.values()].map(r=>({ ...r, lastAtStr: r.lastAt ? r.lastAt.toLocaleString() : "—"}));
  }

  function renderCustomers(){
    const allTbody = $("customersTable")?.querySelector("tbody");
    const topTbody = $("topCustomersTable")?.querySelector("tbody");
    if(!allTbody || !topTbody) return;

    const rows = buildCustomersFromOrders().sort((a,b)=>b.spend-a.spend);
    const top = rows.slice(0,10);

    const toRow = (c)=>`
      <tr>
        <td><b>${c.name}</b></td>
        <td class="muted">${c.phone}</td>
        <td class="muted">${c.orders}</td>
        <td>${fmtMoney(c.spend)}</td>
        <td class="muted">${c.lastAtStr}</td>
      </tr>
    `;
    topTbody.innerHTML = top.map(toRow).join("") || `<tr><td colspan="5" class="muted">No customers in period.</td></tr>`;
    allTbody.innerHTML = rows.map(toRow).join("") || `<tr><td colspan="5" class="muted">No customers in period.</td></tr>`;
  }

  function renderRefunds(){
    const tbody = $("refundsTable")?.querySelector("tbody");
    if(!tbody) return;
    const {start, end} = getPeriodRange();

    const refunds = ordersCache.filter(o=>{
      const at = o?.refund?.at?.toDate ? o.refund.at.toDate() : null;
      if(!at) return false;
      return at >= start && at <= end;
    }).map(o=>{
      const at = o.refund.at.toDate();
      const total = Number(o?.totals?.total||0);
      const amt = calcRefundAmount(o);
      return {
        id: o.id,
        orderNo: o.orderNumber || o.shortId || o.id.slice(-6),
        at,
        amt,
        reason: o.refund.reason || "—",
        cashier: o?.payment?.cashier || o?.payment?.cashierName || "—",
      };
    }).sort((a,b)=>b.at-a.at);

    const totalRefunded = refunds.reduce((a,x)=>a+x.amt,0);
    $("refundsTotalChip").textContent = `Total refunded: ${fmtMoney(totalRefunded)}`;

    tbody.innerHTML = refunds.map(r=>`
      <tr>
        <td><b>#${r.orderNo}</b></td>
        <td class="muted">${r.at.toLocaleString()}</td>
        <td>${fmtMoney(r.amt)}</td>
        <td class="muted">${String(r.reason).replaceAll("<","&lt;")}</td>
        <td class="muted">${r.cashier}</td>
        <td><button class="btn" data-id="${r.id}">Open</button></td>
      </tr>
    `).join("") || `<tr><td colspan="6" class="muted">No refunds in selected period.</td></tr>`;

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = ()=> openOrder(btn.dataset.id);
    });
  }

  $("btnSlaRefresh").onclick = renderKitchenSLA;
  $("slaStuckMin").onchange = renderKitchenSLA;

  $("btnCustomersExport").onclick = ()=>{
    const rows = buildCustomersFromOrders().sort((a,b)=>b.spend-a.spend);
    const header = ["name","phone","orders","spend","lastOrder"];
    const lines = [header.join(",")];
    rows.forEach(c=>{
      const vals = [c.name, c.phone==="—"?"":c.phone, c.orders, fmtMoney(c.spend), c.lastAtStr]
        .map(v=>`"${String(v).replaceAll('"','""')}"`);
      lines.push(vals.join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `customers_${BRAND_ID}_${toISODate(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  $("btnRefundsExport").onclick = ()=>{
    const {start, end, mode} = getPeriodRange();
    const rows = ordersCache.filter(o=>{
      const at = o?.refund?.at?.toDate ? o.refund.at.toDate() : null;
      return at && at>=start && at<=end;
    }).map(o=>{
      const at = o.refund.at.toDate();
      const total = Number(o?.totals?.total||0);
      const amt = calcRefundAmount(o);
      return [
        o.id,
        (o.orderNumber||o.shortId||o.id.slice(-6)),
        at.toLocaleString(),
        fmtMoney(amt),
        (o.refund.reason||""),
        (o?.payment?.cashier||o?.payment?.cashierName||"")
      ];
    });
    const header = ["orderId","orderNumber","refundAt","amount","reason","cashier"];
    const lines = [header.join(",")].concat(rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `refunds_${BRAND_ID}_${toISODate(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

/**************************************************************
   * 14) Orders center
   **************************************************************/
  function rowBadge(status){
    if(status==="completed") return `<span class="badge b-ok">completed</span>`;
    if(status==="preparing") return `<span class="badge b-warn">preparing</span>`;
    if(status==="cancelled") return `<span class="badge b-bad">cancelled</span>`;
    return `<span class="badge">${status||"—"}</span>`;
  }
  function tsToStr(ts){
    const d = ts?.toDate ? ts.toDate() : null;
    if(!d) return "—";
    return d.toLocaleString();
  }

  function renderOrdersTable(){
    const tbody = $("ordersTable").querySelector("tbody");
    if(!tbody) return;

    const s = $("fStatus").value;
    const p = $("fPay").value;
    const r = $("fRefund").value;

    let rows = ordersCache.slice();
    if(s!=="all") rows = rows.filter(o=>o.status===s);
    if(p!=="all") rows = rows.filter(o=>(o?.payment?.method||"")===p);
    if(r==="refunded") rows = rows.filter(o=>o?.refund?.at);

    tbody.innerHTML = rows.map(o=>{
      const created = o?.timestamps?.createdAt?.toDate ? o.timestamps.createdAt.toDate() : null;
      const completed = o?.timestamps?.completedAt?.toDate ? o.timestamps.completedAt.toDate() : null;
      const prep = (created && completed) ? msToHuman(completed-created) : "—";
      const flags = [
        o?.refund?.at ? "refunded" : null,
        (o?.totals?.discount||0)>0 ? "discount" : null
      ].filter(Boolean).join(", ");
      const cust = o?.customer?.name || "—";
      return `
        <tr data-id="${o.id}">
          <td><b>#${o.orderNumber || o.shortId || o.id.slice(-6)}</b></td>
          <td>${tsToStr(o?.timestamps?.createdAt)}</td>
          <td>${rowBadge(o.status)}</td>
          <td>${fmtMoney(o?.totals?.total)}</td>
          <td class="muted">${o?.payment?.method||"—"}</td>
          <td class="muted">${cust}</td>
          <td class="muted">${prep}</td>
          <td class="muted">${flags||"—"}</td>
        </tr>
      `;
    }).join("");

    [...tbody.querySelectorAll("tr")].forEach(tr=>{
      tr.onclick = ()=> openOrder(tr.dataset.id);
    });

    if(selectedOrder){
      // keep drawer updated
      const still = ordersCache.find(x=>x.id===selectedOrder.id);
      if(still) openOrder(still.id, true);
    }
  }

  $("fStatus").onchange = renderOrdersTable;
  $("fPay").onchange = renderOrdersTable;
  $("fRefund").onchange = renderOrdersTable;

  async function openOrder(orderId, silent=false){
    const o = ordersCache.find(x=>x.id===orderId);
    if(!o) return;
    selectedOrder = o;
    $("odTitle").textContent = `Order #${o.orderNumber || o.shortId || o.id.slice(-6)} — ${o.status || "—"}`;

    // Items
    const items = (o.items||[]).map(it=>`
      <div class="kpi" style="margin-bottom:10px">
        <div class="t">${it.name || "Item"} × ${it.qty || 1}</div>
        <div class="v">${fmtMoney((Number(it.price||0))*(Number(it.qty||1)))}</div>
        <div class="s">${it.note ? ("Note: "+it.note) : "—"}</div>
      </div>
    `).join("") || `<div class="notice">No items.</div>`;
    $("odItems").innerHTML = items + `
      <div class="notice" style="margin-top:10px">
        <b>Totals</b><br>
        Subtotal: ${fmtMoney(o?.totals?.subtotal)}<br>
        Discount: ${fmtMoney(o?.totals?.discount)}<br>
        Tax: ${fmtMoney(o?.totals?.tax)}<br>
        <b>Total: ${fmtMoney(o?.totals?.total)}</b>
      </div>
      ${o.orderNote ? `<div class="notice" style="margin-top:10px"><b>Kitchen note:</b> ${o.orderNote}</div>` : ""}
    `;

    // Timeline
    const tl = [];
    tl.push(`<b>Created:</b> ${tsToStr(o?.timestamps?.createdAt)}`);
    tl.push(`<b>Paid:</b> ${tsToStr(o?.payment?.paidAt)}`);
    if(o?.timestamps?.completedAt) tl.push(`<b>Completed:</b> ${tsToStr(o.timestamps.completedAt)}`);
    if(o?.timestamps?.cancelledAt) tl.push(`<b>Cancelled:</b> ${tsToStr(o.timestamps.cancelledAt)}`);
        if(o?.refund?.at){
      const rAmt = calcRefundAmount(o);
      const rReason = o?.refund?.reason ? (" — "+o.refund.reason) : "";
      tl.push(`<b>Refund:</b> ${fmtMoney(rAmt)} at ${tsToStr(o.refund.at)}${rReason}`);
    }
    $("odTimeline").innerHTML = tl.join("<br>");

    // QR preview (simple link)
    const receiptUrl = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(o.id)}`;
    $("odQr").innerHTML = `<div class="notice"><a target="_blank" rel="noopener" href="${receiptUrl}">${receiptUrl}</a></div>`;

    if(!silent) showPage("orders");
  }

  $("btnOdReceipt").onclick = ()=>{
    if(!selectedOrder) return;
    const url = `receipt.html?brandId=${encodeURIComponent(BRAND_ID)}&orderId=${encodeURIComponent(selectedOrder.id)}`;
    window.open(url, "_blank");
  };

  $("btnOdComplete").onclick = async ()=>{
    if(!selectedOrder) return;
    if(!confirm("Mark this order as completed?")) return;
    try{
      await updateDoc(doc(db,"brands",BRAND_ID,"orders",selectedOrder.id), {
        status:"completed",
        "timestamps.completedAt": serverTimestamp(),
        "timestamps.updatedAt": serverTimestamp()
      });
    }catch(e){ alert(e.message||"Failed"); }
  };

  $("btnOdCancel").onclick = async ()=>{
    if(!selectedOrder) return;
    if(!confirm("Cancel this order?")) return;
    try{
      await updateDoc(doc(db,"brands",BRAND_ID,"orders",selectedOrder.id), {
        status:"cancelled",
        "timestamps.cancelledAt": serverTimestamp(),
        "timestamps.updatedAt": serverTimestamp()
      });
    }catch(e){ alert(e.message||"Failed"); }
  };

  $("btnOdRefund").onclick = async ()=>{
    if(!selectedOrder) return;
    if(!confirm("Record refund?")) return;

    const amtRaw = ($("refundAmt")?.value ?? "").toString().trim();
    const reason = ($("refundReason")?.value ?? "").toString().trim();

    // POS-compatible schema
    const total = Number(selectedOrder?.totals?.total||0);
    const isFull = amtRaw === "";
    const amt = isFull ? total : Number(amtRaw);

    if(!isFull && (!isFinite(amt) || amt < 0 || amt > total)){
      return alert("Refund amount must be between 0 and order total.");
    }

    const cashierName = (selectedOrder?.meta?.staffUsername || selectedOrder?.payment?.cashier || auth.currentUser?.email || "—");
    const payMethod = (selectedOrder?.payment?.method || null);

    const refundObj = isFull
      ? { full:true, mode:"full", amount: total, reason: reason||null, at: serverTimestamp(), cashier: cashierName, method: payMethod, source:"dashboard" }
      : { full:false, mode:"amount", amount: amt, reason: reason||null, at: serverTimestamp(), cashier: cashierName, method: payMethod, source:"dashboard" };

    try{
      await updateDoc(doc(db,"brands",BRAND_ID,"orders",selectedOrder.id), {
        refund: refundObj,
        "timestamps.updatedAt": serverTimestamp()
      });
      $("refundAmt").value="";
      $("refundReason").value="";
    }catch(e){ alert(e.message||"Failed"); }
  };
  $("btnOdNote").onclick = async ()=>{
    if(!selectedOrder) return;
    const note = prompt("Internal note (for disputes):");
    if(note==null) return;
    try{
      await updateDoc(doc(db,"brands",BRAND_ID,"orders",selectedOrder.id), {
        internalNote: note.trim() || null,
        "timestamps.updatedAt": serverTimestamp()
      });
    }catch(e){ alert(e.message||"Failed"); }
  };

  // CSV export (filtered)
  $("btnExportCsv").onclick = ()=>{
    const s = $("fStatus").value;
    const p = $("fPay").value;
    const r = $("fRefund").value;
    let rows = ordersCache.slice();
    if(s!=="all") rows = rows.filter(o=>o.status===s);
    if(p!=="all") rows = rows.filter(o=>(o?.payment?.method||"")===p);
    if(r==="refunded") rows = rows.filter(o=>o?.refund?.at);

    const header = ["orderId","orderNumber","status","createdAt","paidAt","completedAt","cancelledAt","total","paymentMethod","customerName","refundAmount","refundReason"];
    const lines = [header.join(",")];
    rows.forEach(o=>{
      const total = Number(o?.totals?.total||0);
      const rAmt = o?.refund?.at ? (o.refund.amount==null?total:Number(o.refund.amount||0)) : "";
      const vals = [
        o.id,
        (o.orderNumber||o.shortId||""),
        (o.status||""),
        tsToStr(o?.timestamps?.createdAt),
        tsToStr(o?.payment?.paidAt),
        tsToStr(o?.timestamps?.completedAt),
        tsToStr(o?.timestamps?.cancelledAt),
        fmtMoney(total),
        (o?.payment?.method||""),
        (o?.customer?.name||""),
        rAmt===""? "" : fmtMoney(rAmt),
        (o?.refund?.reason||"")
      ].map(v=>`"${String(v).replaceAll('"','""')}"`);
      lines.push(vals.join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `orders_${BRAND_ID}_${toISODate(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  function exportFinanceCsv(){
    const {start, end} = getPeriodRange();
    const rows = ordersCache.filter(o=>inRangeOrder(o,start,end) && o.status!=="cancelled");
    const byMethod = new Map();
    rows.forEach(o=>{
      const m = (o?.payment?.method||"unknown");
      const rec = byMethod.get(m) || {count:0,gross:0,discount:0,refunded:0,net:0};
      const gross = Number(o?.totals?.subtotal||0);
      const disc = Number(o?.totals?.discount||0);
      const total = Number(o?.totals?.total||0);
      const refunded = o?.refund?.at ? calcRefundAmount(o) : 0;
      rec.count += 1;
      rec.gross += gross;
      rec.discount += disc;
      rec.refunded += refunded;
      rec.net += Math.max(0, total - refunded);
      byMethod.set(m, rec);
    });

    const header = ["paymentMethod","orders","gross","discount","refunded","net"];
    const lines = [header.join(",")];
    [...byMethod.entries()].sort((a,b)=>b[1].net-a[1].net).forEach(([m,rec])=>{
      const line = [m, rec.count, rec.gross.toFixed(2), rec.discount.toFixed(2), rec.refunded.toFixed(2), rec.net.toFixed(2)]
        .map(v=>`"${String(v).replaceAll('"','""')}"`).join(",");
      lines.push(line);
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `finance_${BRAND_ID}_${toISODate(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }


  /**************************************************************
   * 15) Staff management (username + PIN)
   **************************************************************/
  $("btnCreateStaff").onclick = async ()=>{
    const u = $("staffUser").value.trim();
    const pin = $("staffPin").value.trim();
    const role = $("staffRole").value;
    // Prevent duplicate usernames
    if(staffCache.some(s=>String(s.username||s.id||"").trim().toLowerCase()===u.toLowerCase())){
      return $("staffMsg").textContent = "This username already exists.";
    }
    if(!u || !pin) return $("staffMsg").textContent = "Enter username + PIN.";
    if(pin.length < 4) return $("staffMsg").textContent = "PIN must be 4+ digits.";
    $("staffMsg").textContent = "Creating…";
    try{
      const pinHash = await sha256Hex(pin);
      const id = safeId(u);
      await setDoc(doc(db,"brands",BRAND_ID,"staff",id), {
        username:u,
        role,
        pinHash,
        active:true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});
      $("staffMsg").textContent = "Staff created.";
      $("staffUser").value=""; $("staffPin").value="";
    }catch(e){
      console.error(e);
      $("staffMsg").textContent = e.message||"Failed.";
    }
  };
  $("btnClearStaff").onclick = ()=>{ $("staffUser").value=""; $("staffPin").value=""; $("staffMsg").textContent=""; };

  function renderStaffTable(){
    const tbody = $("staffTable").querySelector("tbody");
    tbody.innerHTML = staffCache.map(s=>{
      const active = !!s.active;
      return `
        <tr>
          <td><b>${s.username||s.id}</b></td>
          <td class="muted">${s.role||"—"}</td>
          <td>${active ? `<span class="badge b-ok">active</span>` : `<span class="badge b-bad">disabled</span>`}</td>
          <td class="muted">${tsToStr(s.createdAt)}</td>
          <td>
            <button class="btn" data-act="toggle" data-id="${s.id}">${active?"Disable":"Enable"}</button>
            <button class="btn danger" data-act="delete" data-id="${s.id}">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const ref = doc(db,"brands",BRAND_ID,"staff",id);
        if(act==="toggle"){
          const s = staffCache.find(x=>x.id===id);
          await updateDoc(ref, { active: !s.active, updatedAt: serverTimestamp() });
        }else if(act==="delete"){
          if(!confirm("Delete this staff user?")) return;
          await deleteDoc(ref);
        }
      };
    });
  }

  /**************************************************************
   * 16) Devices management
   **************************************************************/
  $("btnCreateDevice").onclick = async ()=>{
    const name = $("devName").value.trim();
    const role = $("devRole").value;
    const ver = $("devVer").value.trim();
    if(!name) return alert("Enter device name.");
    try{
      const id = safeId(name);
      await setDoc(doc(db,"brands",BRAND_ID,"devices",id), {
        name, role,
        version: ver || null,
        locked:false,
        lastOnlineAt:null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});
      $("devName").value=""; $("devVer").value="";
    }catch(e){ alert(e.message||"Failed"); }
  };
  $("btnClearDevice").onclick = ()=>{ $("devName").value=""; $("devVer").value=""; };

  function renderDevicesTable(){
    const tbody = $("devicesTable").querySelector("tbody");
    tbody.innerHTML = devicesCache.map(d=>{
      const locked = !!d.locked;
      return `
        <tr>
          <td><b>${d.name||d.id}</b></td>
          <td class="muted">${d.role||"—"}</td>
          <td>${locked ? `<span class="badge b-bad">locked</span>` : `<span class="badge b-ok">unlocked</span>`}</td>
          <td class="muted">${tsToStr(d.lastOnlineAt)}</td>
          <td>
            <button class="btn" data-act="lock" data-id="${d.id}">${locked?"Unlock":"Lock"}</button>
            <button class="btn danger" data-act="delete" data-id="${d.id}">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const ref = doc(db,"brands",BRAND_ID,"devices",id);
        if(act==="lock"){
          const d = devicesCache.find(x=>x.id===id);
          await updateDoc(ref, { locked: !d.locked, updatedAt: serverTimestamp() });
        }else if(act==="delete"){
          if(!confirm("Delete this device?")) return;
          await deleteDoc(ref);
        }
      };
    });
  }

  /**************************************************************
   * 17) Products (create, delete, image upload) + CSV template/import
   **************************************************************/
  $("btnCreateProduct").onclick = async ()=>{
    const name = $("pName").value.trim();
    const category = $("pCat").value.trim();
    const price = Number($("pPrice").value||0);
    const desc = $("pDesc").value.trim() || null;
    const imgFile = $("pImg").files?.[0] || null;

    if(!name || !category) return $("prodMsg").textContent = "Name + category required.";
    if(!isFinite(price) || price<0) return $("prodMsg").textContent = "Price must be valid.";
    $("prodMsg").textContent = "Creating…";
    try{
      let imageUrl = null;
      if(imgFile){
        const path = `brands/${BRAND_ID}/products/${safeId(name)}_${Date.now()}`;
        imageUrl = await uploadImage(imgFile, path);
      }
      const id = safeId(`${name}_${category}_${Date.now()}`);
      await setDoc(doc(db,"brands",BRAND_ID,"products",id), {
        name, category, price, desc,
        imageUrl,
        active:true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, {merge:true});
      $("prodMsg").textContent = "Product created.";
      $("pName").value=""; $("pCat").value=""; $("pPrice").value=""; $("pDesc").value=""; $("pImg").value="";
    }catch(e){
      console.error(e);
      $("prodMsg").textContent = e.message || "Failed.";
    }
  };
  $("btnClearProduct").onclick = ()=>{ $("pName").value=""; $("pCat").value=""; $("pPrice").value=""; $("pDesc").value=""; $("pImg").value=""; $("prodMsg").textContent=""; };

  function renderProductsTable(){
    const tbody = $("productsTable").querySelector("tbody");
    tbody.innerHTML = productsCache.map(p=>{
      const img = p.imageUrl ? `<a href="${p.imageUrl}" target="_blank" class="muted">view</a>` : "—";
      return `
        <tr>
          <td><b>${p.name||"—"}</b></td>
          <td class="muted">${p.category||"—"}</td>
          <td>${fmtMoney(p.price)}</td>
          <td class="muted">${img}</td>
          <td class="muted">${tsToStr(p.updatedAt)}</td>
          <td>
            <button class="btn" data-act="toggle" data-id="${p.id}">${p.active===false?"Enable":"Disable"}</button>
            <button class="btn danger" data-act="delete" data-id="${p.id}">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const ref = doc(db,"brands",BRAND_ID,"products",id);
        if(act==="toggle"){
          const p = productsCache.find(x=>x.id===id);
          await updateDoc(ref, { active: !(p.active!==false), updatedAt: serverTimestamp() });
        }else if(act==="delete"){
          if(!confirm("Delete this product?")) return;
          await deleteDoc(ref);
        }
      };
    });
  }

  // Download template CSV (Excel-friendly)
  $("btnDownloadTemplate").onclick = ()=>{
    const header = ["name","category","price","desc","imageUrl","active"];
    const sample = [
      ["Burger","Sandwiches","120","Beef burger",""],
      ["Fries","Sides","60","Crispy fries",""],
      ["Cola","Drinks","35","Can",""]
    ];
    const lines = [header.join(",")].concat(sample.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `products_template_${BRAND_ID}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // Import CSV
  $("importFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    $("prodMsg").textContent = "Importing…";
    try{
      let rows = [];
      const nameLower = (file.name||"").toLowerCase();

      if(nameLower.endsWith(".xlsx")){
        // XLSX via SheetJS
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false});
      }else{
        // CSV
        const text = await file.text();
        rows = parseCsv(text);
      }

      if(!rows || rows.length<2) throw new Error("File seems empty.");
      const header = rows[0].map(h=>String(h||"").trim().toLowerCase());
      const idx = (name)=> header.indexOf(name);

      const iName = idx("name");
      const iCat = idx("category");
      const iDesc = idx("desc");
      const iPrice = idx("price");
      const iImg = idx("imageurl");
      const iActive = idx("active");

      if(iName<0 || iCat<0 || iPrice<0) throw new Error("Import requires columns: name, category, price. Optional: desc, imageUrl, active.");

      let ok=0, bad=0;
      for(let r=1; r<rows.length; r++){
        const row = rows[r] || [];
        if(row.every(c=>String(c||"").trim()==="")) continue;

        const name = String(row[iName]||"").trim();
        const category = String(row[iCat]||"").trim();
        const price = Number(String(row[iPrice]||"").trim());
        const desc = iDesc>=0 ? (String(row[iDesc]||"").trim()||null) : null;
        const imageUrl = iImg>=0 ? (String(row[iImg]||"").trim()||null) : null;

        let active = true;
        if(iActive>=0){
          const a = String(row[iActive]||"").trim().toLowerCase();
          if(a==="false" || a==="0" || a==="no") active = false;
        }

        if(!name || !category || !isFinite(price)){ bad++; continue; }
        const id = safeId(`${name}_${category}_${Date.now()}_${r}`);
        await setDoc(doc(db,"brands",BRAND_ID,"products",id), {
          name, category, price, desc, imageUrl,
          active,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, {merge:true});
        ok++;
      }
      $("prodMsg").textContent = `Import done. Added ${ok}, skipped ${bad}.`;
      $("importFile").value = "";
    }catch(err){
      console.error(err);
      $("prodMsg").textContent = err.message || "Import failed.";
      $("importFile").value = "";
    }
  });

  function parseCsv(text){
    // minimal CSV parser (handles quotes)
    const rows = [];
    let row = [];
    let cur = "";
    let inQ = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];
      if(inQ){
        if(ch === '"' && next === '"'){ cur += '"'; i++; }
        else if(ch === '"'){ inQ = false; }
        else cur += ch;
      }else{
        if(ch === '"'){ inQ = true; }
        else if(ch === ','){ row.push(cur); cur=""; }
        else if(ch === '\n'){
          row.push(cur); rows.push(row);
          row=[]; cur="";
        }else if(ch === '\r'){ /* ignore */ }
        else cur += ch;
      }
    }
    if(cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  /**************************************************************
   * 18) Reports buttons
   **************************************************************/
  function renderReportView(){
    // Uses overview KPIs + alerts already updated
  }
$("btnReportFinance").onclick = ()=> exportFinanceCsv();
$("btnReportOps").onclick = ()=>{ showPage("overview"); window.print(); };
$("btnReportExec").onclick = ()=>{ showPage("reports"); window.print(); };


  /**************************************************************
   * 19) Dangerous bulk delete (orders)
   **************************************************************/
  $("btnDeleteAllOrders").onclick = async ()=>{
    if(!confirm("Cancel ALL orders for this vendor? (Writes status=cancelled — no hard deletes)")) return;
    const snap = await getDocs(query(ordersCol(), limit(1000)));
    let n=0;
    for(const d of snap.docs){
      const o = d.data()||{};
      if(o.status==="cancelled") continue;
      await updateDoc(d.ref, {
        status:"cancelled",
        "timestamps.cancelledAt": serverTimestamp(),
        "timestamps.updatedAt": serverTimestamp()
      });
      n++;
    }
    alert(`Cancelled ${n} orders (first 1000). If you have more, run again.`);
  };
  /**************************************************************
   * 20) Print button
   **************************************************************/
  $("btnPrint").onclick = ()=> window.print();

</script>
</body>
</html>
